TCP（Transmission Control Protocol，传输控制协议）是一种*面向连接的、可靠的传输层协议*，广泛*用于互联网通信*。它为应用程序提供了一种*可靠的数据传输方式*，*确保数据能够完整、有序地*从发送方传递到接收方。

---

## 一、TCP 的特点
1. **面向连接**：
   - 在传输数据之前，必须先建立连接（三次握手）。
   - 数据传输完成后，需要断开连接（四次挥手）。
2. **可靠性**：
   - 提供确认机制、重传机制和校验机制，确保数据可靠传输。
3. **有序性**：
   - 数据包按发送顺序到达接收方。
4. **流量控制**：
   - 使用滑动窗口机制避免发送方发送数据过快导致接收方无法处理。
5. **拥塞控制**：
   - 动态调整发送速率，避免网络拥塞。
6. **全双工通信**：
   - 支持同时发送和接收数据。

---

## 二、TCP 的工作流程

### 1. 建立连接（三次握手）
- **第一次握手**：
  - 客户端向服务器发送一个 SYN（同步）包，表示*请求建立连接*。
  - 示例：
    ```
    客户端 -> SYN -> 服务器
    ```
- **第二次握手**：
  - 服务器收到 SYN 包后，回复一个 SYN+ACK（同步+确认）包，表示*同意建立连接*。
  - 示例：
    ```
    服务器 -> SYN+ACK -> 客户端
    ```
- **第三次握手**：
  - 客户端收到 SYN+ACK 包后，再发送一个 ACK（确认）包，*完成连接建立*。
  - 示例：
    ```
    客户端 -> ACK -> 服务器
    ```

---

### 2. 数据传输
- *数据被分割成多个小的数据段（Segment），每个数据段包含序列号和确认号*。
- 发送方通过滑动窗口机制*控制发送速率*。
- *接收方通过确认机制告知发送方已成功接收的数据*。

---

### 3. 断开连接（四次挥手）
- **第一次挥手**：
  - *主动关闭连接的一方*（通常是客户端）发送一个 FIN（结束）包，表示*不再发送数据*。
  - 示例：
    ```
    客户端 -> FIN -> 服务器
    ```
- **第二次挥手**：
  - 服务器收到 FIN 包后，回复一个 ACK 包，表示*已收到关闭请求*。
  - 示例：
    ```
    服务器 -> ACK -> 客户端
    ```
- **第三次挥手**：
  - 服务器发送一个 FIN 包，表示*自己也准备关闭连接*。
  - 示例：
    ```
    服务器 -> FIN -> 客户端
    ```
- **第四次挥手**：
  - 客户端收到 FIN 包后，回复一个 ACK 包，*完成连接关闭*。
  - 示例：
    ```
    客户端 -> ACK -> 服务器
    ```

---

## 三、TCP 的头部结构
TCP 头部是一个固定长度为 20 字节的基本部分，可能还包含可选字段。以下是 TCP 头部的主要字段：

| 字段名称  | 长度（位） | 描述                                          |
| ----- | ----- | ------------------------------------------- |
| 源端口号  | 16    | 发送方的端口号。                                    |
| 目的端口号 | 16    | 接收方的端口号。                                    |
| 序列号   | 32    | 当前数据段的第一个字节的序列号，用于*保证数据的有序性*。               |
| 确认号   | 32    | 期望接收的下一个字节的序列号，*用于确认已接收到的数据*。               |
| 数据偏移  | 4     | 表示 TCP 头部的长度（以 4 字节为单位）。                    |
| 标志位   | 6     | 包括 SYN、ACK、FIN、RST（重置）、PSH（推送）、URG（紧急）等标志位。 |
| 窗口大小  | 16    | 表示接收方的缓冲区剩余空间大小，用于*流量控制*。                   |
| 校验和   | 16    | 用于检测数据传输过程中的错误。                             |
| 紧急指针  | 16    | 指示紧急数据的位置（仅在 URG 标志位为 1 时有效）。               |

---

## 四、TCP 的可靠性机制

### 1. 确认机制（ACK）
- 接收方收到数据后，会发送一个确认包（ACK），*告诉发送方哪些数据已经成功接收*。
- 如果发送方未收到 ACK，则会*重新发送数据*。

### 2. 超时重传
- 如果发送方在一定时间内未收到 ACK，则认为数据丢失，并重新发送数据。

### 3. 校验和
- 每个 TCP 数据段都包含一个校验和字段，用于检测数据在传输过程中是否发生错误。

### 4. 序列号
- 每个字节都有唯一的序列号，确保数据按顺序到达接收方。

### 5. 滑动窗口
- 发送方和接收方使用滑动窗口机制控制数据流，避免发送方发送数据过快导致接收方无法处理。

---

## 五、TCP 的应用场景
1. **Web 浏览**：
   - HTTP/HTTPS 基于 TCP 协议。
2. **文件传输**：
   - FTP（文件传输协议）基于 TCP。
3. **电子邮件**：
   - SMTP、POP3、IMAP 均基于 TCP。
4. **远程登录**：
   - SSH、Telnet 基于 TCP。
5. **实时通信**：
   - 虽然 UDP 更适合实时通信，但某些场景（如 WebSocket）也使用 TCP。

---

## 六、TCP 的优缺点

### 优点
1. **可靠性高**：
   - 确保数据完整、有序地传输。
2. **支持流量控制和拥塞控制**：
   - 避免网络拥塞和资源浪费。
3. **适用范围广**：
   - 适用于需要高可靠性的场景。

### 缺点
1. **开销较大**：
   - 需要建立连接、维护状态、发送确认包等，*增加了延迟和资源消耗*。
2. **不适合实时性要求高的场景**：
   - 如视频通话、在线游戏等，通常使用 UDP。

---

## **七、TCP 与 UDP 的对比**

| 特性             | TCP                          | UDP                          |
|------------------|------------------------------|------------------------------|
| 连接类型         | 面向连接                     | 无连接                       |
| 可靠性           | 高                           | 低                           |
| 数据顺序         | 保证有序                     | 不保证有序                   |
| 流量控制         | 支持                         | 不支持                       |
| 拥塞控制         | 支持                         | 不支持                       |
| 开销             | 较大                         | 较小                         |
| 应用场景         | 文件传输、Web 浏览、邮件等   | 视频通话、在线游戏、DNS 等   |

---

## 相关资料
参考：[[02.TCP协议：如何保证页面文件能被完整送达浏览器？]]