# 《桌面程序的架构建议》内容总结

这篇文章由七牛云许式伟撰写，深入探讨了桌面应用程序的架构设计原则，特别是对MVC架构范式的深度解析和实践建议。

## 核心架构范式：MVC

- **MVC定义**：模型(Model)-视图(View)-控制器(Controller)
- **传统理解误区**：Model是Input，View是Output，Controller是Process
- **准确理解**：
  - Model是数据（更准确说是承载业务逻辑的DOM，即"文档对象模型"）
  - View是数据的显示结果，同时接受用户交互事件
  - Controller接受"Model+由View转发的事件"作为输入，处理结果是更新Model

## MVC变种

- **MVP**（Model-View-Presenter）：Model数据更新后，由Presenter负责监听并更新View
- **MVVM**（Model-View-ViewModel）：引入ViewModel层，为View界面呈现专门设计的数据模型

## 架构评判标准

- **最低耦合原则**：不同子系统间应有最少的交互频率和最简洁自然的接口
- **单一职责原则**：一个子系统不应干多件事，也不应不干事情

## 三层架构深度解析

### 1. Model层

- **核心价值**：承载业务逻辑的DOM，是"负责业务需求的内核逻辑"（DataCore）
- **常见误区**：
  - 直接让Controller操作数据库
  - 基于ORM技术实现Model层，仍让Controller直接操作
- **关键特征**：
  - 接口应自然体现业务需求，与底层技术无关
  - 从跨平台角度看，Model层越厚越好（与操作系统框架无关，易测试，易跨平台）
  - 需发出DataChanged事件，使上层能感知Model变化
- **设计原则**：Model层边界应稳定，与实现技术解耦

### 2. View层

- **首要责任**：负责界面呈现（直接调用GDI或创建子View）
- **次要责任**：作为用户交互事件的入口
- **关键设计点**：
  - 应将事件委托(delegate)出去，不要自己处理
  - 可能需要支持界面元素组的共同委托机制
  - 与Model层关系紧密，可能需要Model提供专享只读接口
  - 局部更新优化常需引入ViewModel层（如Word的分页显示需要排版引擎）
- **ViewModel理解**：作者认为ViewModel是View层的一部分，是View层复杂化后的再拆分，而非独立架构层

### 3. Controller层

- **核心职责**：负责用户交互，可有多个Controller处理不同交互需求
- **设计特点**：
  - 应进行正交分解，各Controller间完全无耦合
  - 可包含辅助View（持续可见如菜单，或临时性如旋转控制点）
  - 通过事件驱动状态，调用Model接口完成业务
- **关键考量**：代码内聚性，相关代码应放在一起
- **跨平台优势**：若View层提供良好事件绑定接口，Controller大部分逻辑与操作系统框架无关

## 整体架构组织

- **分层关系**：
  - Model层在最底层
  - View层在中间，持有Model层DOM指针
  - Controller层在最上方，知道Model和View层
- **模块串联**：由应用程序(Application)在启动时创建并关联各模块

## 兼顾API与交互

- **二次开发需求**：桌面程序需提供应用程序接口(API)
- **API提供层建议**：最佳选择是在ViewModel层提供API接口
  - Model层也可提供，但可能缺少重要元素如Selection

## 核心洞见

- **架构本质**：无论clean code架构、四层架构、六边形架构还是微服务架构，核心思想都是"稳定点与变化点分离，分而治之"
- **Model层重要性**：Model层是架构的基石，应尽可能厚重，承载核心业务逻辑
- **跨平台考量**：将逻辑向Model层倾斜，可使Controller层更简洁，极大提升跨平台开发效率
- **架构灵活性**：理解架构原则比死守特定模式更重要，应根据实际需求灵活应用

文章强调，一千个人眼中有一千个哈姆雷特，虽然都在谈MVC，但每个人的理解各有不同。关键是要理解架构原则，根据业务需求设计出符合最低耦合和单一职责原则的系统结构。