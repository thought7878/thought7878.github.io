
# SplitChunks 插件的基本原理

SplitChunks 是 Webpack 中用于代码分割的重要插件。**它的主要目的**是*将应用中的公共模块、异步加载模块以及体积较大的模块等**从原始的代码块（Chunks）** 中提取出来，形成独立的代码块，从而优化应用的加载性能*。

例如，在一个包含多个页面（每个页面是一个入口点）的 Web 应用中，多个页面可能都使用了相同的工具库（如`lodash`）。SplitChunks 可以*将这个公共的`lodash`模块提取到一个单独的代码块中，避免在每个页面的代码块中都重复打包`lodash`*，**减少了代码的冗余**，并且在浏览器缓存这个独立的`lodash`代码块后，后续访问其他页面时**可以直接使用缓存**，提升了加载速度。


# 代码分割、分包的规则

## 设置分包范围

`chunks`参数

- 取值可以是`"initial"`（仅对入口点生成的初始代码块进行分割）、`"async"`（仅对异步加载的代码块进行分割）或`"all"`（对所有代码块，包括初始和异步的进行分割）。
- 一般来说，`"all"`是比较常用的配置，因为它能最大程度地发挥代码分割的优势，例如：

```js
optimization: {
    splitChunks: {
        chunks: 'all'
    }
}
```

## 设置公共模块
### `minChunks`
- 表示一个模块至少被多少个代码块引用才会被提取。例如，设置`minChunks`为 2 意味着一个模块*必须被至少两个不同的代码块引用才会被提取成独立的代码块，这有助于提取真正的公共模块*：

```js
optimization: {
    splitChunks: {
	     // 设定引用次数超过 2 的模块才进行分包
        minChunks: 2
    }
}
```

## 设置分包的数量


## 设置分包的体积
### `minSize`

- 用于设置代码块的最小尺寸（以字节为单位）。小于这个尺寸的模块通常*不会被提取成独立的代码块*。
- 合理设置`minSize`可以*避免生成过多过小的代码块，因为过小的代码块会增加网络请求次数，影响性能*。例如，设置`minSize`为 30000（即 30KB）可以确保只有体积足够大的模块才被分割：

```js
optimization: {
    splitChunks: {
        minSize: 30000
    }
}
```
  

### `maxSize`
- 它用于*限制代码块的最大尺寸*。当一个代码块超过这个尺寸时，Webpack 会尝试*将其进一步分割*。
- 这有助于*避免生成过大的代码块*，因为过大的代码块可能会导致加载时间过长。不过，设置`maxSize`可能会增加构建时间和复杂度，需要根据实际情况权衡。例如：

```js
optimization: {
    splitChunks: {
        maxSize: 200000 // 200KB
    }
}
```

## 规则的优先级顺序


## 缓存组 `cacheGroups` 

### `cacheGroups`
这是 SplitChunks 配置中最灵活和复杂的部分，用于*定义不同类型模块的分组和提取规则*。

**`vendors`分组**：

通常用于*提取第三方库*（如`node_modules`中的模块）。例如：

```js
cacheGroups: {
    vendors: {
        test: /[\\/]node_modules[\\/]/,
        priority: -10
    }
}
```

- `test`属性使用正则表达式来*匹配`node_modules`中的模块*。
- `priority`属性用于*设置优先级*，较低的优先级（如 - 10）表示*在有冲突的情况下，这个分组的提取规则会在其他规则之后应用*。

**`default`分组**：

用于*处理其他不符合特定分组规则的公共模块*。例如：

```js
cacheGroups: {
    default: {
        minChunks: 2,
        priority: -20,
        reuseExistingChunk: true
    }
}
```

- `minChunks`为 2 表示模块至少被两个代码块引用，
- `priority`为 - 20 设置了优先级，
- `reuseExistingChunk`为`true`表示*如果已经有一个合适的现有代码块包含了该模块，就直接使用这个代码块，而不是重新创建一个*。



# 最佳实践

## 结合业务场景优化代码分割

### 按功能模块分割

如果应用有清晰的功能模块划分，如用户认证模块、内容展示模块、购物车模块等，可以利用 SplitChunks 将每个模块相关的代码分割成独立的代码块。

例如，对于一个电商应用，将所有与购物车相关的 JavaScript 和 CSS 代码（包括购物车组件、计算总价函数等）通过 SplitChunks 提取到一个独立的购物车代码块中。当用户访问购物车页面时，只需要加载这个购物车代码块和一些公共的基础代码块，减少了不必要的代码加载，提升了页面加载速度。

### 处理第三方库

正确处理第三方库对于性能提升非常重要。如前面提到的，将`node_modules`中的第三方库通过`vendors`分组提取到独立的代码块中。

此外，还可以根据第三方库的使用频率和大小进一步优化。例如，如果有一个体积较大但不是每个页面都使用的第三方图表库，可以将其作为一个异步代码块，只有在需要展示图表的页面通过动态导入（`import()`）来加载这个库，避免在初始加载时就将这个大库加载进来。

### 考虑用户行为和页面访问频率

分析用户在应用中的行为模式和不同页面的访问频率，来决定哪些代码块应该优先加载，哪些可以延迟加载。

例如，在一个新闻应用中，用户可能首先访问新闻列表页面，然后再点击查看具体的新闻内容。可以将新闻详情页的代码（如新闻内容展示组件、评论组件等）分割成独立的代码块，并且通过动态加载的方式，在用户点击查看新闻详情时再加载这些代码块，从而优化初始加载性能。

# 参考
[[16 如何正确使用 SplitChunks提升应用性能？]]