## GitHub Actions é…ç½®è¯¦è§£ï¼šä»å…¥é—¨åˆ°é«˜çº§å®æˆ˜

GitHub Actions çš„æ ¸å¿ƒæ˜¯ **YAML æ ¼å¼çš„å·¥ä½œæµé…ç½®æ–‡ä»¶**ï¼Œå­˜æ”¾åœ¨ä»“åº“çš„ `.github/workflows/` ç›®å½•ä¸‹ã€‚æœ¬æ–‡å°†ç³»ç»Ÿè§£æé…ç½®è¯­æ³•ã€å…³é”®å‚æ•°å’Œå®æˆ˜æŠ€å·§ï¼ŒåŠ©ä½ æ„å»ºé«˜æ•ˆå¯é çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚

---

### ä¸€ã€åŸºç¡€é…ç½®ç»“æ„ï¼ˆå¿…çŸ¥å¿…ä¼šï¼‰

#### 1. æ–‡ä»¶ä½ç½®ä¸å‘½å
```bash
your-repo/
â””â”€â”€ .github/
    â””â”€â”€ workflows/
        â”œâ”€â”€ ci.yml        # ä¾‹å¦‚ï¼šæŒç»­é›†æˆ
        â”œâ”€â”€ deploy.yml    # ä¾‹å¦‚ï¼šéƒ¨ç½²æµç¨‹
        â””â”€â”€ release.yml   # ä¾‹å¦‚ï¼šç‰ˆæœ¬å‘å¸ƒ
```
- **æ–‡ä»¶æ‰©å±•å**ï¼š`.yml` æˆ– `.yaml`
- **å‘½åè§„åˆ™**ï¼šè‡ªå®šä¹‰ï¼ˆå»ºè®®è§åçŸ¥æ„ï¼‰

#### 2. æœ€ç®€å·¥ä½œæµæ¨¡æ¿
```yaml
name: Basic CI  # å·¥ä½œæµåç§°ï¼ˆæ˜¾ç¤ºåœ¨ GitHub Actions ä»ªè¡¨ç›˜ï¼‰

on: [push]  # è§¦å‘äº‹ä»¶ï¼šæ‰€æœ‰ push æ“ä½œ

jobs:
  build:
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # ä½¿ç”¨é¢„å®šä¹‰ Action
        
      - name: Run a one-liner
        run: echo "Hello GitHub Actions!"
```

---

### äºŒã€æ ¸å¿ƒé…ç½®é¡¹æ·±åº¦è§£æ

#### 1. è§¦å‘äº‹ä»¶ `on`ï¼ˆä½•æ—¶è¿è¡Œï¼Ÿï¼‰

| è§¦å‘æ–¹å¼      | ç¤ºä¾‹                                                         | è¯´æ˜                             |
| --------- | ---------------------------------------------------------- | ------------------------------ |
| **ä»£ç æ¨é€**  | ```<br>on: push<br>```                                     | é»˜è®¤è§¦å‘æ‰€æœ‰åˆ†æ”¯                       |
| **æŒ‡å®šåˆ†æ”¯**  | ```<br>on: <br>  push:<br>    branches: [main, dev]<br>``` | ä»… main å’Œ dev åˆ†æ”¯                |
| **æ‹‰å–è¯·æ±‚**  | ```<br>on: pull_request<br>  paths: ['src/**']<br>```      | **ä»… src ç›®å½•æ”¹åŠ¨æ—¶è§¦å‘**              |
| **å®šæ—¶ä»»åŠ¡**  | ```<br>on:<br>  schedule:<br>    - cron: '0 0 * * *'```    | æ¯å¤© UTC 00:00 æ‰§è¡Œ                |
| **æ‰‹åŠ¨è§¦å‘**  | ```on: workflow_dispatch```                                | åœ¨ Actions UI ç‚¹å‡» "Run workflow" |
| **å¤šäº‹ä»¶ç»„åˆ** | ```on: [push, pull_request]```                             | æ»¡è¶³ä»»ä¸€äº‹ä»¶å³è§¦å‘                      |

> ğŸ’¡ **é«˜çº§æŠ€å·§**ï¼š
> ```yaml
> on:
>   push:
>     tags:        # ä»…å½“æ‰“ tag æ—¶è§¦å‘
>       - 'v*.*.*'  # åŒ¹é… v1.0.0 æ ¼å¼
>   pull_request:
>     types: [opened, synchronize]  # ä»… PR åˆ›å»ºæˆ–æ›´æ–°æ—¶è§¦å‘
> ```

#### 2. ä»»åŠ¡é…ç½® `jobs`ï¼ˆå¦‚ä½•è¿è¡Œï¼Ÿï¼‰
```yaml
jobs:
  test:  # ä»»åŠ¡åç§°ï¼ˆè‡ªå®šä¹‰ï¼‰
    name: Run Tests  # ä»ªè¡¨ç›˜æ˜¾ç¤ºåç§°
    runs-on: ubuntu-22.04  # è¿è¡Œç¯å¢ƒï¼ˆæ”¯æŒ ubuntu/mac/windowsï¼‰
    timeout-minutes: 30    # è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 360ï¼‰
    permissions:           # æœ€å°æƒé™åŸåˆ™ï¼ˆå…³é”®ï¼ï¼‰
      contents: read
      id-token: write      # ç”¨äº AWS OIDC èº«ä»½è”åˆ
    
    # ä»»åŠ¡ä¾èµ–ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
    needs: build  # å¿…é¡»å…ˆå®Œæˆ build ä»»åŠ¡
    
    # ç¯å¢ƒå˜é‡ï¼ˆå…¨å±€ï¼‰
    env:
      NODE_ENV: test
    
    # çŸ©é˜µæµ‹è¯•ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
    strategy:
      matrix:
        node: [16, 18, 20]
        os: [ubuntu-latest, windows-latest]
      fail-fast: false  # ä¸€ä¸ªå¤±è´¥ä¸ä¸­æ–­å…¶ä»–
    
    steps: [...]
```

#### 3. æ­¥éª¤é…ç½® `steps`ï¼ˆå…·ä½“åšä»€ä¹ˆï¼Ÿï¼‰
æ¯ä¸ªæ­¥éª¤æ”¯æŒä¸¤ç§æ‰§è¡Œæ–¹å¼ï¼š

| ç±»å‹             | è¯­æ³•                                | é€‚ç”¨åœºæ™¯   |
| -------------- | --------------------------------- | ------ |
| **Shell å‘½ä»¤**   | ```run: npm test```               | é€šç”¨å‘½ä»¤   |
| **é¢„å®šä¹‰ Action** | ```uses: actions/setup-node@v3``` | å¤ç”¨ç¤¾åŒºä»£ç  |

**æ­¥éª¤å…³é”®å‚æ•°ï¼š**
```yaml
- name: Build Project
  id: build_step  # ä¸ºåç»­æ­¥éª¤æä¾›ä¸Šä¸‹æ–‡
  run: |
    npm ci
    npm run build
  env:  # æœ¬åœ°ç¯å¢ƒå˜é‡
    API_KEY: ${{ secrets.PROD_API_KEY }}
  if: ${{ github.ref == 'refs/heads/main' }}  # æ¡ä»¶æ‰§è¡Œ
  continue-on-error: true  # å¤±è´¥ç»§ç»­ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
```

> âš ï¸ **é‡è¦è§„åˆ™**ï¼š
> 1. `uses` å’Œ `run` **ä¸èƒ½åŒæ—¶å­˜åœ¨**äºåŒä¸€æ­¥éª¤
> 2. `secrets` **åªèƒ½åœ¨ run æ­¥éª¤ä¸­ä½¿ç”¨**ï¼ˆcheckout æ­¥éª¤æ— æ³•è®¿é—®ï¼‰

---

### ä¸‰ã€é«˜çº§é…ç½®æŠ€å·§ï¼ˆæå‡æ•ˆç‡å¿…å¤‡ï¼‰

#### 1. åŠ¨æ€è¡¨è¾¾å¼ä¸ä¸Šä¸‹æ–‡
GitHub Actions æä¾›ä¸°å¯Œçš„[ä¸Šä¸‹æ–‡å¯¹è±¡](https://docs.github.com/en/actions/learn-github-actions/contexts)ï¼Œ*ç”¨äºåŠ¨æ€ç”Ÿæˆé…ç½®*ï¼š

| ä¸Šä¸‹æ–‡ | ç¤ºä¾‹ | è¯´æ˜ |
|--------|------|------|
| **github** | `${{ github.sha }}` | å½“å‰ commit SHA |
| **secrets** | `${{ secrets.DB_PASSWORD }}` | ä»“åº“æœºå¯† |
| **env** | `${{ env.MY_VAR }}` | ç¯å¢ƒå˜é‡ |
| **steps** | `${{ steps.build_step.outputs.time }}` | å‰åºæ­¥éª¤è¾“å‡º |
| **matrix** | `${{ matrix.node }}` | çŸ©é˜µå˜é‡ |

**å®æˆ˜æ¡ˆä¾‹ï¼šåŠ¨æ€ç”Ÿæˆç‰ˆæœ¬å·**
```yaml
- name: Set version
  id: version
  run: echo "version=$(date +%Y%m%d)-${{ github.sha }}" >> $GITHUB_OUTPUT
  shell: bash

- name: Deploy
  run: npm deploy --version ${{ steps.version.outputs.version }}
```

#### 2. ç¯å¢ƒå˜é‡ä¸æœºå¯†ç®¡ç†
```yaml
env:  # å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆæ•´ä¸ª job æœ‰æ•ˆï¼‰
  APP_ENV: production

jobs:
  deploy:
    steps:
      - name: Configure AWS
        env:  # æ­¥éª¤çº§ç¯å¢ƒå˜é‡
          AWS_REGION: us-east-1
        run: aws configure set region $AWS_REGION
        # æœºå¯†åªèƒ½é€šè¿‡è¿™ç§æ–¹å¼æ³¨å…¥
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
```

> ğŸ”’ **æœºå¯†å®‰å…¨æœ€ä½³å®è·µ**ï¼š
> 1. **ç»ä¸ç¡¬ç¼–ç **ï¼š`secrets` åªèƒ½é€šè¿‡ `${{ secrets.NAME }}` å¼•ç”¨
> 2. **æœ€å°æƒé™**ï¼šä¸º CI ä¸“ç”¨è´¦å·åˆ†é…æœ€å°å¿…è¦æƒé™
> 3. **å®¡è®¡æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥ `Settings > Security audit log`

#### 3. é«˜æ•ˆç¼“å­˜ç­–ç•¥
```yaml
- name: Cache dependencies
  uses: actions/cache@v3
  with:
    path: |
      ~/.npm
      node_modules
    key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
    restore-keys: |
      ${{ runner.os }}-node-
```
- **`key`**ï¼šå”¯ä¸€ç¼“å­˜æ ‡è¯†ï¼ˆå˜æ›´æ—¶é‡å»ºç¼“å­˜ï¼‰
- **`restore-keys`**ï¼šç¼“å­˜æœªå‘½ä¸­æ—¶çš„å›é€€ç­–ç•¥

> ğŸ’¡ **æé€Ÿæ•ˆæœ**ï¼šNode.js é¡¹ç›®æ„å»ºæ—¶é—´å‡å°‘ 60%+

#### 4. æ‰‹åŠ¨å®¡æ‰¹æµç¨‹
```yaml
jobs:
  deploy-prod:
    environment: 
      name: production
      url: https://your-app.com  # ä»ªè¡¨ç›˜æ˜¾ç¤ºé“¾æ¥
      production: true           # æ ‡è®°ä¸ºç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    steps:
      - run: ./deploy.sh
```
**é…ç½®å®¡æ‰¹äºº**ï¼š
1. è¿›å…¥ `Settings > Environments > New environment`
2. åˆ›å»º `production` ç¯å¢ƒ
3. åœ¨ `Deployment branches` è®¾ç½®ä¿æŠ¤è§„åˆ™
4. åœ¨ `Required reviewers` æ·»åŠ å®¡æ‰¹äºº

---

### å››ã€å…¸å‹åœºæ™¯é…ç½®æ¨¡æ¿

#### 1. å‰ç«¯é¡¹ç›®è‡ªåŠ¨åŒ–ï¼ˆReact/Vueï¼‰
```yaml
name: Frontend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
        
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
      
      - run: npm ci
      - run: npm run build
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: dist/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build
      
      - name: Deploy to S3
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1
      
      - run: aws s3 sync dist/ s3://$BUCKET_NAME
        env:
          BUCKET_NAME: my-app-bucket
```

#### 2. å®¹å™¨åŒ–åº”ç”¨éƒ¨ç½²ï¼ˆDocker + AWS ECRï¼‰
```yaml
name: Docker Build & Push

on:
  push:
    tags: ['v*']

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/my-app:${{ github.ref_name }}
```

---

### äº”ã€è°ƒè¯•ä¸æ•…éšœæ’é™¤æŒ‡å—

#### 1. å¸¸è§é”™è¯¯è¯Šæ–­

| ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| **"Permission denied"** | æœªé…ç½® secrets æˆ–æƒé™ä¸è¶³ | æ£€æŸ¥ IAM ç­–ç•¥ + Secrets åç§° |
| **"No such file"** | è·¯å¾„é”™è¯¯æˆ–æœª checkout ä»£ç  | ç¡®è®¤ `actions/checkout` æ­¥éª¤å­˜åœ¨ |
| **YAML è¯­æ³•é”™è¯¯** | ç¼©è¿›é”™è¯¯/å†’å·ç¼ºå¤± | ç”¨ [YAML Linter](https://www.yamllint.com/) éªŒè¯ |
| **ç¼“å­˜æœªå‘½ä¸­** | package-lock.json å˜æ›´ | æ£€æŸ¥ `key` å’Œ `restore-keys` é…ç½® |

#### 2. è°ƒè¯•æŠ€å·§
```yaml
- name: Debug environment
  run: |
    echo "Current branch: $GITHUB_REF"
    env  # æ‰“å°æ‰€æœ‰ç¯å¢ƒå˜é‡
    printenv  # è¯¦ç»†ç¯å¢ƒå˜é‡
  shell: bash
```

**é«˜çº§è°ƒè¯•æ–¹æ³•ï¼š**
1. **æœ¬åœ°è¿è¡Œ**ï¼šä½¿ç”¨ [`act`](https://github.com/nektos/act) å·¥å…·
   ```bash
   brew install act  # macOS
   act push          # æ¨¡æ‹Ÿ push äº‹ä»¶
   ```
2. **å¯ç”¨è°ƒè¯•æ—¥å¿—**ï¼š
   - åˆ›å»º secret `ACTIONS_STEP_DEBUG` = `true`
   - é‡æ–°è¿è¡Œå·¥ä½œæµæŸ¥çœ‹è¯¦ç»†æ—¥å¿—

---

### å…­ã€ä¼ä¸šçº§å®‰å…¨é…ç½®

#### 1. æœ€å°æƒé™ç­–ç•¥ï¼ˆå…³é”®ï¼ï¼‰
```yaml
permissions:
  contents: read       # ä»…éœ€è¯»å–ä»£ç 
  pull-requests: write # ä»…éœ€æ›´æ–° PR çŠ¶æ€
  id-token: write      # ç”¨äº AWS OIDC
```
- **é»˜è®¤æƒé™**ï¼š`contents: read` + `metadata: read`
- **ç¦ç”¨æ‰€æœ‰æƒé™**ï¼š
  ```yaml
  permissions: {}
  ```

#### 2. ä½¿ç”¨ OIDC æ›¿ä»£é•¿æœŸå¯†é’¥ï¼ˆAWS ç¤ºä¾‹ï¼‰
```yaml
jobs:
  deploy:
    permissions:
      id-token: write   # å¿…éœ€
      contents: read    # å¿…éœ€
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::123456789012:role/github-actions-role
          aws-region: us-east-1
```
**AWS IAM é…ç½®è¦ç‚¹**ï¼š
1. åˆ›å»º IAM Role
2. æ·»åŠ ä¿¡ä»»ç­–ç•¥ï¼ˆæŒ‡å®š GitHub ä»“åº“ï¼‰
3. é™„åŠ æœ€å°æƒé™ç­–ç•¥ï¼ˆå¦‚ S3 è¯»å†™ï¼‰

> âœ… **å®‰å…¨ä¼˜åŠ¿**ï¼šæ— éœ€å­˜å‚¨é•¿æœŸå¯†é’¥ï¼Œè‡ªåŠ¨è½®æ¢ä¸´æ—¶å‡­è¯

---

### ä¸ƒã€æœ€ä½³å®è·µæ€»ç»“

#### 1. é…ç½®è®¾è®¡åŸåˆ™

| åŸåˆ™       | è¯´æ˜            | åä¾‹                             |
| -------- | ------------- | ------------------------------ |
| **å•ä¸€èŒè´£** | ä¸€ä¸ªå·¥ä½œæµä¸“æ³¨ä¸€ä»¶äº‹    | å°†æµ‹è¯•ã€æ„å»ºã€éƒ¨ç½²æ··åœ¨ä¸€ä¸ªæ–‡ä»¶                |
| **æœ€å°æƒé™** | æŒ‰éœ€ç”³è¯·æƒé™        | æ‰€æœ‰ä»»åŠ¡ç”¨ `permissions: write-all` |
| **ç¼“å­˜ä¼˜å…ˆ** | åˆç†é…ç½®ç¼“å­˜        | æ¯æ¬¡éƒ½ `npm install`              |
| **æ¡ä»¶æ‰§è¡Œ** | ç”¨ `if` å‡å°‘æ— æ•ˆè¿è¡Œ | æ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œéƒ¨ç½²                      |

#### 2. æ€§èƒ½ä¼˜åŒ–æ¸…å•
- [ ] ä½¿ç”¨ `actions/cache` ç¼“å­˜ä¾èµ–
- [ ] çŸ©é˜µæµ‹è¯•æ—¶è®¾ç½® `fail-fast: false`
- [ ] å¤§å‹é¡¹ç›®æ‹†åˆ†å¤šä¸ª Job å¹¶è¡Œæ‰§è¡Œ
- [ ] é¿å…åœ¨ `run` ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- [ ] ç”¨ `paths`/`paths-ignore` å‡å°‘è§¦å‘

#### 3. å®‰å…¨åŠ å›º checklist
- [ ] æ‰€æœ‰ secrets é€šè¿‡ `${{ secrets.NAME }}` å¼•ç”¨
- [ ] ç”Ÿäº§éƒ¨ç½²å¿…é¡»åŒ…å«æ‰‹åŠ¨å®¡æ‰¹
- [ ] ä½¿ç”¨ OIDC æ›¿ä»£é•¿æœŸå¯†é’¥ï¼ˆAWS/Azure/GCPï¼‰
- [ ] å®šæœŸå®¡æŸ¥ `Settings > Secrets`
- [ ] ç¦ç”¨ä¸å¿…è¦çš„æƒé™ï¼ˆ`permissions: {}`ï¼‰

---

### å…«ã€å­¦ä¹ èµ„æºé€ŸæŸ¥

| èµ„æºç±»å‹ | æ¨èé“¾æ¥ |
|----------|----------|
| **å®˜æ–¹æ–‡æ¡£** | [GitHub Actions æ–‡æ¡£](https://docs.github.com/en/actions) |
| **YAML éªŒè¯** | [YAML Linter](https://www.yamllint.com/) |
| **Action å¸‚åœº** | [GitHub Marketplace](https://github.com/marketplace?type=actions) |
| **æœ¬åœ°è°ƒè¯•** | [act å·¥å…·](https://github.com/nektos/act) |
| **æ¨¡æ¿åº“** | [actions/starter-workflows](https://github.com/actions/starter-workflows) |

> ğŸ’¡ **ç»ˆæå»ºè®®**ï¼š  
> 1. ä» **`.github/workflows/ci.yml`** å¼€å§‹ï¼ˆåŸºç¡€æµ‹è¯•ï¼‰  
> 2. é€æ­¥æ·»åŠ  **ç¼“å­˜** å’Œ **ç¯å¢ƒå˜é‡**  
> 3. å¤æ‚æµç¨‹æ‹†åˆ†ä¸º **å¤šä¸ªå·¥ä½œæµæ–‡ä»¶**  
> 4. ç”Ÿäº§éƒ¨ç½²å¿…é¡»åŒ…å« **æ‰‹åŠ¨å®¡æ‰¹** å’Œ **ç¯å¢ƒéš”ç¦»**  

```bash
# å¿«é€Ÿåˆå§‹åŒ–å·¥ä½œæµ
mkdir -p .github/workflows
cat > .github/workflows/ci.yml << EOF
name: CI
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "Your CI starts here!"
EOF
```

é€šè¿‡ç³»ç»ŸåŒ–é…ç½® GitHub Actionsï¼Œä½ å¯ä»¥åœ¨ **10 åˆ†é’Ÿå†…** ä¸ºé¡¹ç›®æ­å»ºä¸“ä¸šçº§ CI/CD æµæ°´çº¿ï¼Œå¤§å¹…æå‡å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ï¼