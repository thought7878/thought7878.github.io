## GitHub Actions 配置详解：从入门到高级实战

GitHub Actions 的核心是 **YAML 格式的工作流配置文件**，存放在仓库的 `.github/workflows/` 目录下。本文将系统解析配置语法、关键参数和实战技巧，助你构建高效可靠的自动化流程。

---

### 一、基础配置结构（必知必会）

#### 1. 文件位置与命名
```bash
your-repo/
└── .github/
    └── workflows/
        ├── ci.yml        # 例如：持续集成
        ├── deploy.yml    # 例如：部署流程
        └── release.yml   # 例如：版本发布
```
- **文件扩展名**：`.yml` 或 `.yaml`
- **命名规则**：自定义（建议见名知意）

#### 2. 最简工作流模板
```yaml
name: Basic CI  # 工作流名称（显示在 GitHub Actions 仪表盘）

on: [push]  # 触发事件：所有 push 操作

jobs:
  build:
    runs-on: ubuntu-latest  # 运行环境
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # 使用预定义 Action
        
      - name: Run a one-liner
        run: echo "Hello GitHub Actions!"
```

---

### 二、核心配置项深度解析

#### 1. 触发事件 `on`（何时运行？）

| 触发方式      | 示例                                                         | 说明                             |
| --------- | ---------------------------------------------------------- | ------------------------------ |
| **代码推送**  | ```<br>on: push<br>```                                     | 默认触发所有分支                       |
| **指定分支**  | ```<br>on: <br>  push:<br>    branches: [main, dev]<br>``` | 仅 main 和 dev 分支                |
| **拉取请求**  | ```<br>on: pull_request<br>  paths: ['src/**']<br>```      | **仅 src 目录改动时触发**              |
| **定时任务**  | ```<br>on:<br>  schedule:<br>    - cron: '0 0 * * *'```    | 每天 UTC 00:00 执行                |
| **手动触发**  | ```on: workflow_dispatch```                                | 在 Actions UI 点击 "Run workflow" |
| **多事件组合** | ```on: [push, pull_request]```                             | 满足任一事件即触发                      |

> 💡 **高级技巧**：
> ```yaml
> on:
>   push:
>     tags:        # 仅当打 tag 时触发
>       - 'v*.*.*'  # 匹配 v1.0.0 格式
>   pull_request:
>     types: [opened, synchronize]  # 仅 PR 创建或更新时触发
> ```

#### 2. 任务配置 `jobs`（如何运行？）
```yaml
jobs:
  test:  # 任务名称（自定义）
    name: Run Tests  # 仪表盘显示名称
    runs-on: ubuntu-22.04  # 运行环境（支持 ubuntu/mac/windows）
    timeout-minutes: 30    # 超时时间（默认 360）
    permissions:           # 最小权限原则（关键！）
      contents: read
      id-token: write      # 用于 AWS OIDC 身份联合
    
    # 任务依赖（串行执行）
    needs: build  # 必须先完成 build 任务
    
    # 环境变量（全局）
    env:
      NODE_ENV: test
    
    # 矩阵测试（并行执行）
    strategy:
      matrix:
        node: [16, 18, 20]
        os: [ubuntu-latest, windows-latest]
      fail-fast: false  # 一个失败不中断其他
    
    steps: [...]
```

#### 3. 步骤配置 `steps`（具体做什么？）
每个步骤支持两种执行方式：

| 类型             | 语法                                | 适用场景   |
| -------------- | --------------------------------- | ------ |
| **Shell 命令**   | ```run: npm test```               | 通用命令   |
| **预定义 Action** | ```uses: actions/setup-node@v3``` | 复用社区代码 |

**步骤关键参数：**
```yaml
- name: Build Project
  id: build_step  # 为后续步骤提供上下文
  run: |
    npm ci
    npm run build
  env:  # 本地环境变量
    API_KEY: ${{ secrets.PROD_API_KEY }}
  if: ${{ github.ref == 'refs/heads/main' }}  # 条件执行
  continue-on-error: true  # 失败继续（谨慎使用）
```

> ⚠️ **重要规则**：
> 1. `uses` 和 `run` **不能同时存在**于同一步骤
> 2. `secrets` **只能在 run 步骤中使用**（checkout 步骤无法访问）

---

### 三、高级配置技巧（提升效率必备）

#### 1. 动态表达式与上下文
GitHub Actions 提供丰富的[上下文对象](https://docs.github.com/en/actions/learn-github-actions/contexts)，*用于动态生成配置*：

| 上下文 | 示例 | 说明 |
|--------|------|------|
| **github** | `${{ github.sha }}` | 当前 commit SHA |
| **secrets** | `${{ secrets.DB_PASSWORD }}` | 仓库机密 |
| **env** | `${{ env.MY_VAR }}` | 环境变量 |
| **steps** | `${{ steps.build_step.outputs.time }}` | 前序步骤输出 |
| **matrix** | `${{ matrix.node }}` | 矩阵变量 |

**实战案例：动态生成版本号**
```yaml
- name: Set version
  id: version
  run: echo "version=$(date +%Y%m%d)-${{ github.sha }}" >> $GITHUB_OUTPUT
  shell: bash

- name: Deploy
  run: npm deploy --version ${{ steps.version.outputs.version }}
```

#### 2. 环境变量与机密管理
```yaml
env:  # 全局环境变量（整个 job 有效）
  APP_ENV: production

jobs:
  deploy:
    steps:
      - name: Configure AWS
        env:  # 步骤级环境变量
          AWS_REGION: us-east-1
        run: aws configure set region $AWS_REGION
        # 机密只能通过这种方式注入
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
```

> 🔒 **机密安全最佳实践**：
> 1. **绝不硬编码**：`secrets` 只能通过 `${{ secrets.NAME }}` 引用
> 2. **最小权限**：为 CI 专用账号分配最小必要权限
> 3. **审计日志**：定期检查 `Settings > Security audit log`

#### 3. 高效缓存策略
```yaml
- name: Cache dependencies
  uses: actions/cache@v3
  with:
    path: |
      ~/.npm
      node_modules
    key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
    restore-keys: |
      ${{ runner.os }}-node-
```
- **`key`**：唯一缓存标识（变更时重建缓存）
- **`restore-keys`**：缓存未命中时的回退策略

> 💡 **提速效果**：Node.js 项目构建时间减少 60%+

#### 4. 手动审批流程
```yaml
jobs:
  deploy-prod:
    environment: 
      name: production
      url: https://your-app.com  # 仪表盘显示链接
      production: true           # 标记为生产环境
    runs-on: ubuntu-latest
    steps:
      - run: ./deploy.sh
```
**配置审批人**：
1. 进入 `Settings > Environments > New environment`
2. 创建 `production` 环境
3. 在 `Deployment branches` 设置保护规则
4. 在 `Required reviewers` 添加审批人

---

### 四、典型场景配置模板

#### 1. 前端项目自动化（React/Vue）
```yaml
name: Frontend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
        
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
      
      - run: npm ci
      - run: npm run build
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: dist/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build
      
      - name: Deploy to S3
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1
      
      - run: aws s3 sync dist/ s3://$BUCKET_NAME
        env:
          BUCKET_NAME: my-app-bucket
```

#### 2. 容器化应用部署（Docker + AWS ECR）
```yaml
name: Docker Build & Push

on:
  push:
    tags: ['v*']

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/my-app:${{ github.ref_name }}
```

---

### 五、调试与故障排除指南

#### 1. 常见错误诊断

| 现象 | 可能原因 | 解决方案 |
|------|----------|----------|
| **"Permission denied"** | 未配置 secrets 或权限不足 | 检查 IAM 策略 + Secrets 名称 |
| **"No such file"** | 路径错误或未 checkout 代码 | 确认 `actions/checkout` 步骤存在 |
| **YAML 语法错误** | 缩进错误/冒号缺失 | 用 [YAML Linter](https://www.yamllint.com/) 验证 |
| **缓存未命中** | package-lock.json 变更 | 检查 `key` 和 `restore-keys` 配置 |

#### 2. 调试技巧
```yaml
- name: Debug environment
  run: |
    echo "Current branch: $GITHUB_REF"
    env  # 打印所有环境变量
    printenv  # 详细环境变量
  shell: bash
```

**高级调试方法：**
1. **本地运行**：使用 [`act`](https://github.com/nektos/act) 工具
   ```bash
   brew install act  # macOS
   act push          # 模拟 push 事件
   ```
2. **启用调试日志**：
   - 创建 secret `ACTIONS_STEP_DEBUG` = `true`
   - 重新运行工作流查看详细日志

---

### 六、企业级安全配置

#### 1. 最小权限策略（关键！）
```yaml
permissions:
  contents: read       # 仅需读取代码
  pull-requests: write # 仅需更新 PR 状态
  id-token: write      # 用于 AWS OIDC
```
- **默认权限**：`contents: read` + `metadata: read`
- **禁用所有权限**：
  ```yaml
  permissions: {}
  ```

#### 2. 使用 OIDC 替代长期密钥（AWS 示例）
```yaml
jobs:
  deploy:
    permissions:
      id-token: write   # 必需
      contents: read    # 必需
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::123456789012:role/github-actions-role
          aws-region: us-east-1
```
**AWS IAM 配置要点**：
1. 创建 IAM Role
2. 添加信任策略（指定 GitHub 仓库）
3. 附加最小权限策略（如 S3 读写）

> ✅ **安全优势**：无需存储长期密钥，自动轮换临时凭证

---

### 七、最佳实践总结

#### 1. 配置设计原则

| 原则       | 说明            | 反例                             |
| -------- | ------------- | ------------------------------ |
| **单一职责** | 一个工作流专注一件事    | 将测试、构建、部署混在一个文件                |
| **最小权限** | 按需申请权限        | 所有任务用 `permissions: write-all` |
| **缓存优先** | 合理配置缓存        | 每次都 `npm install`              |
| **条件执行** | 用 `if` 减少无效运行 | 所有分支都执行部署                      |

#### 2. 性能优化清单
- [ ] 使用 `actions/cache` 缓存依赖
- [ ] 矩阵测试时设置 `fail-fast: false`
- [ ] 大型项目拆分多个 Job 并行执行
- [ ] 避免在 `run` 中硬编码敏感信息
- [ ] 用 `paths`/`paths-ignore` 减少触发

#### 3. 安全加固 checklist
- [ ] 所有 secrets 通过 `${{ secrets.NAME }}` 引用
- [ ] 生产部署必须包含手动审批
- [ ] 使用 OIDC 替代长期密钥（AWS/Azure/GCP）
- [ ] 定期审查 `Settings > Secrets`
- [ ] 禁用不必要的权限（`permissions: {}`）

---

### 八、学习资源速查

| 资源类型 | 推荐链接 |
|----------|----------|
| **官方文档** | [GitHub Actions 文档](https://docs.github.com/en/actions) |
| **YAML 验证** | [YAML Linter](https://www.yamllint.com/) |
| **Action 市场** | [GitHub Marketplace](https://github.com/marketplace?type=actions) |
| **本地调试** | [act 工具](https://github.com/nektos/act) |
| **模板库** | [actions/starter-workflows](https://github.com/actions/starter-workflows) |

> 💡 **终极建议**：  
> 1. 从 **`.github/workflows/ci.yml`** 开始（基础测试）  
> 2. 逐步添加 **缓存** 和 **环境变量**  
> 3. 复杂流程拆分为 **多个工作流文件**  
> 4. 生产部署必须包含 **手动审批** 和 **环境隔离**  

```bash
# 快速初始化工作流
mkdir -p .github/workflows
cat > .github/workflows/ci.yml << EOF
name: CI
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "Your CI starts here!"
EOF
```

通过系统化配置 GitHub Actions，你可以在 **10 分钟内** 为项目搭建专业级 CI/CD 流水线，大幅提升开发效率和代码质量！