`npm` ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆLifecycle Scriptsï¼‰æ˜¯ `package.json` ä¸­ç”¨äºå®šä¹‰é¡¹ç›®*åœ¨ä¸åŒé˜¶æ®µè‡ªåŠ¨æ‰§è¡Œè„šæœ¬*çš„æœºåˆ¶ã€‚è¿™äº›é’©å­ä½¿å¾—å¼€å‘è€…å¯ä»¥*åœ¨å®‰è£…ã€æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒç­‰å…³é”®æ“ä½œå‰å*æ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼Œ*ä»è€Œå®ç°è‡ªåŠ¨åŒ–æµç¨‹*ã€‚

---

## ä¸€ã€ä»€ä¹ˆæ˜¯ npm ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Ÿ

npm æä¾›äº†ä¸€ç³»åˆ—**é¢„å®šä¹‰çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆlifecycle eventsï¼‰**ï¼Œä½ å¯ä»¥åœ¨ `package.json` çš„ `scripts` å­—æ®µä¸­å®šä¹‰è¿™äº›äº‹ä»¶å¯¹åº”çš„è„šæœ¬å‘½ä»¤ï¼Œnpm ä¼šåœ¨ç›¸åº”é˜¶æ®µè‡ªåŠ¨è°ƒç”¨å®ƒä»¬ã€‚

---

## äºŒã€å¸¸è§çš„ npm ç”Ÿå‘½å‘¨æœŸé’©å­

| é’©å­åç§°             | è§¦å‘æ—¶æœº                         | æè¿°                      |
| ---------------- | ---------------------------- | ----------------------- |
| `prepublish`     | å‘å¸ƒå‰æˆ–æœ¬åœ°è¿è¡Œ `npm install` æ—¶ï¼ˆæ—§ç‰ˆï¼‰ | *å·²è¢«å¼ƒç”¨*ï¼Œè¯·ä½¿ç”¨ `prepare`    |
| `prepare`        | å‘å¸ƒå‰ æˆ– æ‰§è¡Œ `git clone` å       | æ›¿ä»£ `prepublish`ï¼Œå¸¸ç”¨äºæ„å»º   |
| `prepublishOnly` | **ä»…åœ¨å‘å¸ƒå‰**è§¦å‘                  | ä¸ä¼šåœ¨æœ¬åœ° `npm install` æ—¶è§¦å‘ |
| `postpublish`    | å‘å¸ƒå®Œæˆåè§¦å‘                      | å¯ç”¨äºé€šçŸ¥æˆ–æ¸…ç†                |
| `preinstall`     | å®‰è£…åŒ…ä¹‹å‰æ‰§è¡Œ                      | é€šå¸¸ç”¨äºæƒé™æ£€æŸ¥æˆ–é…ç½®å‡†å¤‡           |
| `install`        | å®‰è£…åŒ…å®Œæˆåæ‰§è¡Œ                     | å¸¸ç”¨äºåˆå§‹åŒ–å·¥ä½œ                |
| `postinstall`    | å®‰è£…å®Œæˆåæ‰§è¡Œ                      | å¸¸ç”¨äºæ„å»ºã€é“¾æ¥ä¾èµ–ç­‰æ“ä½œ           |
| `preuninstall`   | å¸è½½å‰æ‰§è¡Œ                        | å¯ç”¨äºæ¸…ç†èµ„æº                 |
| `uninstall`      | å¸è½½è¿‡ç¨‹ä¸­æ‰§è¡Œ                      |                         |
| `postuninstall`  | å¸è½½åæ‰§è¡Œ                        |                         |
| `preversion`     | åœ¨è¿è¡Œ `npm version` å‰æ‰§è¡Œ        | å¯ç”¨äºæ£€æŸ¥æ˜¯å¦é€šè¿‡æµ‹è¯•             |
| `version`        | åœ¨ä¿®æ”¹ç‰ˆæœ¬å·åæ‰§è¡Œ                    |                         |
| `postversion`    | ä¿®æ”¹ç‰ˆæœ¬å¹¶æäº¤ Git åæ‰§è¡Œ              | å¸¸ç”¨äºæ¨é€ä»£ç                  |
| `test`           | è¿è¡Œ `npm test` æ—¶æ‰§è¡Œ            | æ¨èç¼–å†™å•å…ƒ/é›†æˆæµ‹è¯•             |
| `start`          | è¿è¡Œ `npm start` æ—¶æ‰§è¡Œ           | é»˜è®¤å€¼ä¸º `node app.js`      |
| `restart`        | è¿è¡Œ `npm restart` æ—¶æ‰§è¡Œ         | ç­‰ä»·äº stop + start        |
| `stop`           | è¿è¡Œ `npm stop` æ—¶æ‰§è¡Œ            | åœæ­¢æœåŠ¡                    |

---

## ä¸‰ã€é’©å­æ‰§è¡Œé¡ºåºç¤ºä¾‹

å½“ä½ è¿è¡Œï¼š

```bash
npm install
```

ä¼šä¾æ¬¡æ‰§è¡Œï¼š
```
preinstall â†’ install â†’ postinstall
```

å½“ä½ è¿è¡Œï¼š

```bash
npm publish
```

ä¼šä¾æ¬¡æ‰§è¡Œï¼š
```
prepublishOnly â†’ prepare â†’ prepublish â†’ publish â†’ postpublish
```

---

## å››ã€å¸¸ç”¨åœºæ™¯ä¸ç¤ºä¾‹

### âœ… åœºæ™¯ 1ï¼šå‘å¸ƒå‰æ„å»º

```json
{
  "scripts": {
    "build": "webpack --mode production",
    "prepare": "npm run build"
  }
}
```

> æ³¨æ„ï¼š`prepare` åœ¨ `npm install` æ—¶ä¹Ÿä¼šæ‰§è¡Œï¼Œå› æ­¤å¦‚æœåªæƒ³åœ¨å‘å¸ƒæ—¶æ„å»ºï¼Œè¯·ä½¿ç”¨ `prepublishOnly`ã€‚

---

### âœ… åœºæ™¯ 2ï¼šå‘å¸ƒå‰æ£€æŸ¥æµ‹è¯•å’Œ lint

```json
{
  "scripts": {
    "lint": "eslint .",
    "test": "jest",
    "prepublishOnly": "npm run lint && npm run test"
  }
}
```

---

### âœ… åœºæ™¯ 3ï¼šå®‰è£…åè‡ªåŠ¨æ„å»ºæœ¬åœ°ä¾èµ–

é€‚ç”¨äºæœ¬åœ°å¼€å‘çš„åº“ï¼š

```json
{
  "scripts": {
    "build": "tsc",
    "postinstall": "npm run build"
  }
}
```

---

### âœ… åœºæ™¯ 4ï¼šç‰ˆæœ¬æ›´æ–°åè‡ªåŠ¨æ¨é€ Git

```json
{
  "scripts": {
    "preversion": "npm test",
    "postversion": "git push && git push --tags"
  }
}
```

---

## äº”ã€æ³¨æ„äº‹é¡¹

- â— `prepare` å’Œ `prepublish` çš„åŒºåˆ«ï¼š
  - `prepare` åœ¨ `npm install` å’Œ `npm publish` æ—¶éƒ½ä¼šè¿è¡Œã€‚
  - `prepublishOnly` åªåœ¨ `npm publish` æ—¶è¿è¡Œã€‚

- âš ï¸ é¿å…åœ¨ `prepare` ä¸­è¿›è¡Œè€—æ—¶æ“ä½œï¼Œå› ä¸ºå®ƒä¼šå½±å“æœ¬åœ° `npm install` çš„é€Ÿåº¦ã€‚

- ğŸ§  `npm version` ä¼šè‡ªåŠ¨æäº¤ Git commit å¹¶æ‰“ tagã€‚

- ğŸ” å¦‚æœä½ çš„æ¨¡å—éœ€è¦ç¼–è¯‘æˆ–æ„å»ºæ‰èƒ½ä½¿ç”¨ï¼Œå»ºè®®ä½¿ç”¨ `prepublishOnly` è€Œä¸æ˜¯ `prepare`ï¼Œé¿å…æ±¡æŸ“ç”¨æˆ·ç¯å¢ƒã€‚

---

## å…­ã€npm vs yarn ç”Ÿå‘½å‘¨æœŸå·®å¼‚

| æ“ä½œ | npm | yarn |
|------|-----|------|
| å®‰è£…ä¾èµ– | `npm install` | `yarn install` |
| ç”Ÿå‘½å‘¨æœŸæ”¯æŒ | æ”¯æŒå®Œæ•´é’©å­ | ä¹Ÿæ”¯æŒå¤§éƒ¨åˆ†é’©å­ |
| ç‰¹æ®Šè¡Œä¸º | `prepare` åœ¨ `install` æ—¶è¿è¡Œ | `prepare` é»˜è®¤ä¸è¿è¡Œï¼ˆé™¤éè®¾ç½®äº† `enableScripts: true`ï¼‰ |

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Yarnï¼Œæ³¨æ„æŸäº›é’©å­å¯èƒ½ä¸ä¼šé»˜è®¤æ‰§è¡Œã€‚

---

## ä¸ƒã€æ€»ç»“ï¼šæ¨èå®è·µ

| ç›®æ ‡ | æ¨èä½¿ç”¨çš„é’©å­ |
|------|----------------|
| å‘å¸ƒå‰æ„å»º | `prepublishOnly` |
| æœ¬åœ°å¼€å‘è‡ªåŠ¨æ„å»º | `postinstall` |
| å‘å¸ƒå‰æ£€æŸ¥ | `prepublishOnly` |
| ç‰ˆæœ¬å‡çº§åå¤„ç† | `postversion` |
| æµ‹è¯• / Lint | `test`, `lint` |
| è‡ªåŠ¨åŒ–éƒ¨ç½² | `postpublish` |

---

å¦‚æœä½ æƒ³ç»“åˆ CI/CD æµç¨‹ï¼ˆå¦‚ GitHub Actionsï¼‰ã€Monorepoï¼ˆå¦‚ Nxã€Lernaã€pnpm workspaceï¼‰æˆ– TypeScript é¡¹ç›®æ¥å®šåˆ¶ npm ç”Ÿå‘½å‘¨æœŸè„šæœ¬ï¼Œæˆ‘ä¹Ÿå¯ä»¥æä¾›æ›´å…·ä½“çš„æ–¹æ¡ˆã€‚æ¬¢è¿ç»§ç»­æé—®ï¼