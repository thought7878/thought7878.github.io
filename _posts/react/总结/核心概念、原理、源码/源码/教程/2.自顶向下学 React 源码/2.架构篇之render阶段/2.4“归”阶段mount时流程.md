本视频讲述了**React归阶段中completeWork的执行流程**，重点解析了*host component的dom节点创建、属性设置、子节点挂载机制*，并解释了首屏渲染时如何通过根节点的placement effect实现整棵dom树的插入。

![[_posts/react/总结/核心概念、原理、源码/源码/教程/2.自顶向下学 React 源码/2.架构篇之render阶段/media/fa7f8fbd3cffc3143bcd86da91792350_MD5.webp]]

## 归阶段流程概述 
[00:16](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=16)

- 本节学习目标  
    学习归阶段 `commit` 十的流程，即 `fiber.completeWork` 所做的工作。
- 调试入口  
    进入测试 demo，搜索 `completeWork` 并打上断点后刷新页面。

## 第一个completeWork执行：Image节点 
[00:33](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=33)

- 节点类型判断  
    第一个进入 `completeWork` 的 fiber 节点是 Image 节点，其 tag 为 host component，因此进入对应的处理分支。
- current存在性判断  
    首屏渲染时 `current` 不存在，故进入 `else` 分支逻辑。
- hydrate相关逻辑跳过  
    hydrate 与 SSR（服务端渲染）相关，本次不关注。

### DOM节点创建：createInstance 
[01:10](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=70)

- 创建实例过程  
    在 `createInstance` 中调用 `createElement`创建 DOM 元素。
- 结果赋值  
    执行完 `createElement` 后，`dom element`即为 Image fiber 节点对应的 image DOM 元素。

### DOM节点插入：appendAllChildren 
[01:42](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=102)

- 插入操作定义  
    将已创建的 DOM 节点插入到父级已创建好的 DOM 树中，该操作在 `appendAllChildren` 中执行。
- 首次创建跳过插入  
    因 Image 是首个创建的 DOM 节点，无父节点可挂载，本次操作被跳过。

### DOM节点保存至stateNode 
[02:05](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=125)

- 保存引用  
    创建完成后，将 image DOM 节点保存在对应 fiber 节点的 `stateNode` 属性上。

### 初始化DOM属性：finalizeInitialChildren 
[02:24](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=144)

- 属性设置范围  
    包括 `alt`、`classroom`（应为 `className`）、`src` 等属性的设置，均在 `finalizeInitialChildren` 中完成。
- 标签类型判断  
    首先判断是否为自定义标签，再根据 host component 的 type 进入不同逻辑。
- props合法性校验  
    判断 `props` 是否合法 [02:56](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=176)。
- 初始化属性流程
    - 判断是否为 `style` 属性。
    - 判断是否为 `children`。
    - 最终进入 `setInitialProperties`。
        - 内部调用 `setPropertyForProperty` 设置属性值。
        - 对 IE8/IE9 做兼容性 polyfill 处理。
    - 最终执行 DOM 节点的 `setAttribute` 方法完成属性赋值 [03:57](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=237)。
- completeWork完成标志  
    当上述操作执行完毕，当前 fiber 节点的 `completeWork` 完成，进入下一个 fiber 节点 [04:09](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=249)。

## 文本节点处理 
[04:25](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=265)

- 文本节点进入completeWork  
    下一个 fiber 节点为文本节点，同样会执行 `completeWork`。
- 函数组件无completeWork逻辑  
    function component 及许多其他类型的 component 没有 `completeWork` 的具体逻辑 [04:27](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=267)。

## appendAllChildren逻辑详解 
[04:37](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=277)

- workingProgress节点  
    当前正在处理的 `workInProgress` 节点是 code 节点。
- 方法作用说明  
    `appendAllChildren` 每次执行时，都会将已创建好的 DOM 节点挂载到当前 DOM 节点下。
- 递归归并过程  
    归阶段从子节点逐层向上返回至根节点时，每个子节点的 DOM 元素都会挂载到其父级 DOM 节点下。
- 最终结果  
    当执行到 APP 节点时，已构建出一棵完整的 DOM 树 [05:16](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=316)。

## 首屏渲染DOM挂载问题解答 
[05:25](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=325)

- 问题回顾  
    `reconcileChildren` 中，若 fiber 节点无对应 `current` 节点，则不会标记 effect tag。
- 疑问提出  
    首屏渲染的 DOM 节点如何被挂载到页面中？[05:45](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=345)
- 断点验证  
    在相关位置打断点并刷新页面观察行为。
- 唯一带current的节点  
    首屏渲染中仅有一个节点具有 `current`，即应用的根 fiber 节点 [05:56](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=356)。
- 根节点特征
    - tag 为 3，表示为 `HostRoot`。
    - 进入 `reconcileSingleElement` 处理逻辑 [06:18](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=378)。
    - 执行完成后调用 `placeSingleChild`[06:27](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=387)。
    - 此时 `shouldTrackSideEffects` 为 true，因此新创建的子 fiber 节点会被赋予 effect tag。
- effect tag赋值  
    APP 节点被赋予 `effectTag: Placement`（值为 3）[06:42](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=402)。

## 完成所有completeWork后的流程 
[06:53](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=413)

- 后续流程入口  
    所有节点执行完 `completeWork` 后，进入 `performSyncWorkOnRoot` 的其他逻辑。
- 断点跟踪  
    在指定位置打断点继续执行 [07:03](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=423)。
- root结构解析
    - `root` 是整个应用唯一的根节点。
    - `root.current` 指向当前应用的 `current` fiber 树根节点 [07:14](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=434)。
    - `current` fiber 树的 `alternate` 指向 `workInProgress` fiber 树的根节点 [07:25](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=445)。

## 根节点结构查看 
[07:35](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=455)

- 根节点child字段  
    根节点的 `child` 是 APP 节点。
- APP节点信息
    - `effectTag` 为 3（Placement）。
    - `child` 指向 div 对应的 fiber 节点。
- finishWork期间的引用
    - `finishedWork.child` 是 APP。
    - `finishedWork.sibling` 是 DIV。
    - DIV 的 `stateNode` 保存了对应的 DOM 节点 [08:02](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=482)。

## DOM树挂载机制总结 
[08:26](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=506)

- 挂载执行位置  
    每个 host component 的 `appendAllChildren`完成了 DOM 节点的挂载。
- 整树插入原理  
    只需在 APP 节点这一层级拥有 `Placement`effect tag，即可将整棵已构建好的 DOM 树插入页面 [08:35](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=515)。
- 首屏渲染插入逻辑结论  
    这就是首屏渲染中 DOM 插入的核心机制 [08:45](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=525)。

## 下一节预告 
[08:48](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=528)

- 下一节课将讲解 D 阶段的 `commit` 流程。