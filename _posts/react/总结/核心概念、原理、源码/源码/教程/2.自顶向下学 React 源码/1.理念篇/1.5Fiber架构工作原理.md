本视频讲述了React中fiber架构的工作原理，包括*fiber的三层含义、数据结构设计、双缓存机制*的核心概念。

![[cdf9b5c740a9899e7ff38ed9c837d70c_MD5.webp]]

### Fiber的含义 
[00:17](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=17)

- 作为架构  
    React 15 的协调器采用递归方式执行，被称为 `stack reconciler`；React 16 使用基于 fiber 节点的协调器，称为 `fiber reconciler`。
- 作为静态的数据结构  
    每个 fiber 节点对应一个组件，保存组件类型、对应的 DOM 节点等信息，也被称为虚拟节点。
- 作为动态的工作单元  
    fiber 节点保存组件需要更新的状态和副作用，用于实现可中断的更新机制。

### Fiber节点的连接方式 
[02:03](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=123)

- child 与 return 的作用  
    子节点通过 `child` 属性连接，父节点则通过 `return` 表示，这种设计源于 `stack reconciler` 中的递归执行模型。
- 具体连接示例
    - `fiber root node.current` 指向 `root fiber`。
    - `root fiber.child` 指向 `APP`。
    - `APP.child` 指向 `P`。
    - `P.child` 指向“卡送”。
    - “卡送”.`sibling` 指向 “number”。
    - “number”.`return` 指向 `P`。
    - `P.return` 指向 `APP`。
    - `APP.return` 指向 `root fiber`。
    - `root fiber.stateNode` 指向 `fiber root node`。

### Fiber节点的数据结构 
[03:54](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=234)

- 作为静态数据结构的属性
    
    - `tag`: fiber 对应的组件类型，如 function component、class component 或 host component。
    - `key`: 组件的 key 属性。
    - `elementType` 与 `type`: 大多数情况下相同，但在使用 `React.memo` 包裹函数组件时不同。
    - `type`: 对于 function component 是函数本身，对于 class component 是类，对于 host component 是 DOM tag name。
    - `stateNode`: 对应的真实 DOM 节点（host component）。
    - `return`, `child`, `sibling`: 构建 fiber 树的连接关系。
    - `index`: 同级 fiber 在 DOM 插入顺序中的索引。
    - `ref`: 组件的 ref 属性。
- 作为动态工作单元的属性
    
    - `pendingProps` 到 `alternate`: 这些属性在 fiber 作为工作单元时使用。
    - 名称中带有 `effect` 的字段：表示副作用相关操作。
        - host component 的副作用包括 DOM 增删查改。
        - function component 的副作用由 `useEffect` 或 `useLayoutEffect`触发。
    - `lane` 相关属性：与优先级调度有关。
    - `alternate`: 双缓存机制的关键字段。

### 双缓存机制 
[05:40](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=340)

- 动画原理与双缓存的引入  
    动画由连续帧组成，传统渲染中切换帧可能导致白屏闪烁；双缓存在内存中构建完整帧后直接替换，避免闪烁。
- React中的应用
    - 首次调用 `ReactDOM.render` 创建 `fiber root node` 和 `root fiber`。
    - `fiber root node.current` 指向当前展示的 `root fiber`。
    - 每次更新创建一棵新的 `work in progress fiber` 树。
    - 更新完成后，`fiber root node.current` 指针指向新树的根节点，旧树变为备用状态。
- current 与 workInProgress 的关系
    - current 树代表当前页面内容。
    - workInProgress 树是正在构建的新版本。
    - 所有存在的 fiber 节点通过 `alternate` 属性互相连接。
    - diff 算法在此过程中对比 current 节点与新 JSX 结构，生成 workInProgress fiber。

### 总结 
[09:22](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=562)

- fiber 具有三层含义：静态数据结构、动态工作单元、整体架构设计。
- fiber 数据结构包含多种关键属性，支持组件类型识别、树结构连接、状态更新与副作用处理。
- 双缓存机制通过两棵树交替更新，实现高效、可中断的 UI 渲染流程。