本视频讲述了JSX的本质及其与React Element、React Component、Fiber架构的内在关系，通过Babel编译演示、源码分析和运行时劫持实验，阐明JSX最终被编译为`React.createElement`调用，其返回值是满足`$$typeof === REACT_ELEMENT_TYPE`条件的合法React Element；React Component（Class或Function）作为type参数传入该函数；而Fiber节点的创建与更新则直接依赖于组件返回的JSX对象。

![[1d5d98594bfad4d875339615f055e942_MD5.webp]]

### JSX本质与编译机制 
[00:52](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=52)

- Babel在线编译演示 [00:38](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=38)  
    使用Babel在线编辑器演示JSX编译过程。
- 无插件编译报错 [01:02](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=62)  
    未配置插件时，Babel无法识别JSX语法，报错。
- 插件配置与编译目标 [01:16](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=76)  
    添加插件`@babel/transform-react-jsx`后，JSX被编译为`React.createElement`调用。
- 可配置编译目标 [01:35](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=95)  
    插件支持自定义编译目标，如Preact中JSX编译为`h()`函数调用。
![[_posts/react/总结/核心概念、原理、源码/源码/教程/2.自顶向下学 React 源码/2.架构篇之render阶段（协调器的执行过程）/media/2f972df0673847f2ea6dc718a1da68a1_MD5.webp]]

### React.createElement方法解析 
[01:47](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=107)

- 方法签名与参数含义 [02:17](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=137)  
    `React.createElement(type, config, children)`接收三个参数。
- type参数详解 [02:37](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=157)  
    `type`为字符串（如`'div'`、`'p'`）时，对应host component；改为`'p'`后，`type`参数随之变更。
- config参数详解 [03:03](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=183)  
    `config`为JSX属性对象，如添加`title="hello"`，则`config`为`{ title: "hello" }`。
- children参数详解 [03:15](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=195)  
    `children`为子元素，若为嵌套JSX，则递归编译为另一层`React.createElement`调用。
- 内部字段处理 [03:39](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=219)  
    方法内定义`key`、`ref`等保留字段。
- config合法性校验 [03:46](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=226)  
    若`config`非`null`，校验`ref`与`key`字段合法性并赋值。
- props属性赋值逻辑 [04:01](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=241)  
    遍历`config`，将非保留属性赋给`props`。
- 保留属性列表 [04:11](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=251)  
    保留属性包括`key`、`ref`、`__self`、`__source`。
- 保留属性传递方式 [04:25](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=265)  
    保留属性作为独立参数传入，不进入`props`。
- defaultProps处理 [04:32](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=272)  
    `defaultProps`从`type`（即组件定义）中获取。
- Class Component的type与defaultProps [04:44](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=284)  
    `class A extends React.Component`中，`A`作为`type`传入，其`defaultProps`属性即为`defaultProps`来源。

### React Element对象结构 
[05:50](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=350)

- ReactElement构造调用 [05:50](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=350)  
    `React.createElement`最终调用`ReactElement`方法。
- 开发环境标记 [06:19](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=379)  
    `__DEV__`为开发环境条件分支，生产环境为`false`。
- 返回对象结构 [06:38](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=398)  
    返回对象含`$$typeof`字段，其值为常量`REACT_ELEMENT_TYPE`。
- isValidElement判定逻辑 [06:50](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=410)  
    合法React Element需满足：为`object`、非`null`、含`$$typeof`字段且值为`REACT_ELEMENT_TYPE`。
- createElement结果即Element [07:19](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=439)  
    所有`React.createElement`调用返回值均为合法React Element。

### **React Component与Element的关系** 
[07:27](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=447)

- Function Component的type [07:50](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=470)  
    函数组件function B() {}作为type传入React.createElement。
- **React Element定义** [08:00](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=480)  
    *React Element即React.createElement调用的返回值*。
- **React Component定义** [08:13](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=493)  
    *Class Component为class定义本身；Function Component为function本身*。
- **Component与Element关系** [08:24](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=504)  
    *Component作为React.createElement的第一个参数（type）参与Element构建*。

### **JSX与Fiber架构的关系** 
[08:34](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=514)

- 首屏渲染Fiber树构建 [08:38](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=518)  
    **首屏渲染时，依据组件返回的JSX、ReactElement对象，创建workInProgress Fiber树**。
- 更新阶段Fiber对比 [08:46](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=526)  
    **更新时，将组件返回的JSX、ReactElement对象与对应 `current` Fiber对比，生成新的`workInProgress`Fiber节点**。

### 运行时劫持验证JSX影响 
[09:14](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=554)

- 全局React对象定位 [09:45](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=585)  
    通过`React DevTools`注入的`__REACT_DEVTOOLS_GLOBAL_HOOK__`获取`react`对象。
- renderers字段定位 [10:07](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=607)  
    `hook.renderers`中找到浏览器渲染器`react-dom`。
- 反压缩定位createElement [10:44](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=644)  
    在`react-dom`源码中定位`createElement`方法（压缩代码中含`fiber`字段）。
- 劫持createElement实现标签替换 [12:28](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=748)  
    重写`React.createElement`：当`type === 'div'`时，强制设为`'span'`，再调用原函数。
- 劫持效果验证 [12:55](https://b.quark.cn/apps/5AZ7aRopS/routes/quark-video-ai-summary/pc?debug=0&fid=24a5c265c54f495bba51ddb53eeec646#?seek_t=775)  
    页面滚动触发更新后，大量`<div>`标签被替换为`<span>`标签，证实JSX编译结果直接影响DOM输出。