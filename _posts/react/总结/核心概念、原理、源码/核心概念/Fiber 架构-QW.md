React 的 **Fiber 架构** 是 _React 16_ 引入的一种全新的协调（Reconciliation）机制，旨在解决传统 Stack Reconciler 在处理复杂 UI 和高优先级任务时的*性能瓶颈问题*。Fiber 架构的**核心目标**是实现**可中断的渲染**、**时间切片**和**任务优先级调度**，从而提升用户体验和应用性能。

以下是 Fiber 架构的详细解析：

---

## 1. 为什么需要 Fiber 架构？

在 React 16 之前，React 使用的是 **Stack Reconciler**（栈调和器）。_它的工作方式类似于函数调用栈_：当组件树更新时，React 会递归地遍历整个树，计算出需要更新的部分并同步更新 DOM。_这种方式存在以下问题：_

### 无法中断渲染

- Stack Reconciler 是**同步的**，_一旦开始渲染，就无法中断。如果组件树非常大，可能会导致主线程被长时间占用，造成页面卡顿或掉帧_。

### 缺乏优先级管理

- *所有更新都被视为同等重要，无法区分用户交互（如点击按钮）和低优先级任务（如后台数据加载）*。

### 不支持并发模式

- 无法暂停、恢复或放弃某些渲染任务，限制了 React 的灵活性。

**为了解决这些问题**，React 团队引入了 **Fiber 架构**，_通过将渲染任务拆分为更小的单元，并引入任务优先级调度机制，实现了更高效的渲染_。

---

## 2. Fiber 架构的核心概念

### Fiber 节点

`Fiber` 是*一种新的数据结构*，用于表示 Fiber 树（根据组件树构建的）中的每个节点。每个 Fiber 节点包含以下信息：

- **类型（Type）**：组件的类型（如函数组件、类组件、原生 DOM 元素等）。
- **状态（State）**：组件的状态（如 `useState` 的状态）。
- **属性（Props）**：组件的 props。
- **子节点（Child）**：指向当前节点的第一个子节点。
- **兄弟节点（Sibling）**：指向当前节点的下一个兄弟节点。
- **父节点（Return）**：指向当前节点的父节点。
- **副作用（Effects）**：记录需要执行的 DOM 操作或其他副作用。

Fiber 节点本质上是一个链表，React 通过这种链表结构实现了对组件树的遍历和更新。

### 双缓冲技术

Fiber 架构使用了双缓冲技术，维护了两棵树：

- **当前树（Current Tree）**：表示当前*已渲染到屏幕上*的组件树。
- **工作树（Work-in-Progress Tree）**：表示*正在构建*的新组件树。

*当 React 完成一次更新后，工作树会替换当前树，成为新的当前树*。

---

## 3. Fiber 架构的工作流程

Fiber 架构的工作流程可以分为以下几个阶段：

### 调度阶段（Scheduling Phase）

- **任务优先级**：React *根据任务的优先级（如用户交互、动画、后台任务等）决定何时执行任务*。
- **时间切片**：React 将渲染任务拆分为多个小块，每块任务在一定时间内完成（通常为 5ms），避免阻塞主线程。

### 协调阶段（Reconciliation Phase）

- **构建工作树**：React *遍历组件树，构建工作树，并计算出需要更新的部分*。
- **标记副作用**：React *记录需要执行的 DOM 操作或其他副作用*（如生命周期方法、Hooks 的副作用）。

### 提交阶段（Commit Phase）

- **执行 DOM 操作**：React 将工作树中的更新应用到真实 DOM。
- **触发生命周期方法**：React 调用相关的生命周期方法（如 `componentDidMount`、`useEffect` 等）。

---

## 4. Fiber 架构的关键特性

### 时间切片

React 将渲染任务拆分为多个小块，每块任务在一定时间内完成（通常为 5ms）。这样可以*避免阻塞主线程*，确保页面流畅。

### 任务优先级

React 将任务分为不同的优先级：

- **同步任务**：如*用户输入、动画*等需要立即响应的任务。
- **异步任务**：如*数据加载、后台计算*等可以延迟的任务。

React *根据任务的优先级决定何时执行任务，确保高优先级任务优先得到处理*。

### 并发模式（可中断的渲染）

Fiber 架构允许 React 在渲染过程中暂停、恢复甚至放弃某些任务。例如：

- *当用户交互（如点击按钮）发生时，React 可以暂停当前的低优先级任务，优先处理用户交互*。
- *当浏览器空闲时，React 可以继续处理未完成的任务*。


---

## 5. Fiber 架构的优势

### 提升性能

通过可中断的渲染和时间切片，React 可以避免长时间占用主线程，减少页面卡顿和掉帧。

### 支持并发模式

Fiber 架构为 React 提供了并发模式（Concurrent Mode）的基础，允许 React 在高优先级任务和低优先级任务之间进行调度。

### 更好的用户体验

通过优先级管理和时间切片，React 可以优先处理用户交互，确保页面响应迅速。

---

## 6. Fiber 架构的应用场景

### 复杂组件树

对于包含大量组件的复杂组件树，Fiber 架构可以通过时间切片和任务优先级管理，避免一次性渲染导致的性能问题。

### 高优先级任务

对于需要立即响应的任务（如用户输入、动画），Fiber 架构可以优先处理这些任务，确保用户体验。

### 后台任务

对于低优先级任务（如数据加载、后台计算），Fiber 架构可以将其延迟执行，避免影响页面性能。

---

## 7. 总结：Fiber 架构的核心原理

Fiber 架构是 React 的核心创新之一，其核心原理可以概括为以下几点：

1. **Fiber 节点**：使用链表结构表示组件树中的每个节点。
2. **双缓冲技术**：维护当前树和工作树，确保高效更新。
3. **可中断的渲染**：允许 React 在渲染过程中暂停、恢复甚至放弃某些任务。
4. **时间切片**：将渲染任务拆分为多个小块，避免阻塞主线程。
5. **任务优先级**：根据任务的优先级决定何时执行任务，确保高优先级任务优先得到处理。

通过 Fiber 架构，React 实现了更高效的渲染和更灵活的任务调度，为现代 Web 应用提供了强大的性能保障。
