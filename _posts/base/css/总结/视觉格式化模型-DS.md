`视觉格式化模型（Visual Formatting Model）`是 CSS 的核心概念之一，**它定义了浏览器如何将 DOM 树中的元素转换为可视化的页面布局**。**这一模型通过规则描述元素如何生成盒子（Box）、如何排列，以及如何相互影响，最终渲染为屏幕上的像素**。

---

### **1. 视觉格式化模型的核心概念**
#### **(1) 盒子模型（Box Model）**
- 每个元素在渲染时都会生成一个或多个 **盒子**（如块级盒子、行内盒子），盒子由以下部分组成：
  - **内容区**（Content）：元素的实际内容（如文本、图片）。
  - **内边距**（Padding）：内容区与边框之间的空白。
  - **边框**（Border）：围绕内容和内边距的边界。
  - **外边距**（Margin）：盒子与其他盒子之间的间距。
- 盒子大小计算方式由 `box-sizing` 控制：
  - `content-box`（默认）：宽度 = 内容宽度。
  - `border-box`：宽度 = 内容 + 内边距 + 边框。

#### **(2) 包含块（Containing Block）**
- 元素的布局和尺寸计算通常基于其 **包含块**（*最近的块级祖先元素的区域*）。
- 例如：
  - *绝对定位元素的包含块*是最近的非 `static` 定位祖先。
  - *百分比宽度*基于包含块的宽度。

#### **(3) 定位方案（Positioning Schemes）**
视觉格式化模型支持三种主要定位方式：
1. **普通流（Normal Flow）**：
   - 元素按照 HTML 顺序依次排列。
   - 块级元素垂直堆叠，行内元素水平排列。
   - 默认定位方式（`position: static` / `relative`）。

2. **浮动（Float）**：
   - 元素脱离普通流，向左/右浮动。
   - 其他内容环绕浮动元素（如文字环绕图片）。

3. **绝对定位（Absolute Positioning）**：
   - 元素脱离普通流，相对于包含块定位（`position: absolute` / `fixed`）。
   - 不占据原文档流空间，可能覆盖其他内容。

---

### **2. 视觉格式化模型的组成部分**
#### **(1) 块级格式化上下文（BFC）**
- 见前文详解，BFC 控制块级元素的布局规则（如避免浮动塌陷、阻止外边距合并）。

#### **(2) 行内格式化上下文（IFC）**
- 控制行内元素的布局规则（如文本对齐、`vertical-align` 生效）。

#### **(3) 弹性盒子（Flexbox）与网格（Grid）**
- 现代布局模型，属于视觉格式化模型的扩展：
  - **Flexbox**：一维布局（水平或垂直排列），支持动态伸缩。
  - **Grid**：二维布局（行和列），支持复杂网格结构。

---

### **3. 视觉格式化模型的关键规则**
#### **(1) 垂直外边距合并（Margin Collapsing）**
- **触发条件**：普通流中，垂直相邻的块级元素上下外边距会合并。
  ```css
  .box1 { margin-bottom: 20px; }
  .box2 { margin-top: 30px; }
  /* 实际间距为 30px（合并后取较大值） */
  ```
- **如何避免**：通过 BFC 隔离元素（如父容器添加 `overflow: hidden`）。

#### **(2) 匿名盒子（Anonymous Boxes）**
- 当块级元素包含行内元素时，浏览器自动生成匿名块盒包裹行内内容。
  ```html
  <div>
    这是一段文本，<span>行内元素</span>。
  </div>
  ```
  - 文本和 `<span>` 会被包裹在匿名块盒中。

#### **(3) 替换元素与非替换元素**
- **替换元素**：内容由外部资源决定（如 `<img>`、`<input>`），尺寸默认由内容决定。
- **非替换元素**：内容由 HTML 或 CSS 控制（如 `<div>`、`<span>`）。

---

### **4. 示例：浮动与清除浮动**
#### **问题：父容器高度塌陷**
```html
<div class="parent">
  <div class="float-child">浮动元素</div>
</div>
```
- 若 `.float-child` 设置 `float: left`，父容器 `.parent` 的高度会塌陷为 0。

#### **解决方案：触发 BFC**
```css
.parent {
  overflow: hidden; /* 触发 BFC，包含浮动元素 */
}
```

---

### **5. 视觉格式化模型 vs 格式化上下文**
- **视觉格式化模型**：宏观规则，描述所有元素的布局方式（包含块、定位方案、盒子模型等）。
- **格式化上下文**：微观规则，描述特定容器内子元素的排列方式（如 BFC、IFC、Flex、Grid）。

---

### **总结**
理解视觉格式化模型，需掌握以下核心：
1. **盒子模型**：元素如何计算尺寸。
2. **包含块**：元素如何定位和计算百分比。
3. **定位方案**：普通流、浮动、绝对定位的区别。
4. **格式化上下文**：不同上下文（BFC、Flex、Grid）如何控制子元素布局。

通过这一模型，可以精准控制页面布局，解决浮动塌陷、外边距合并等问题，并选择最合适的布局方案（传统 BFC 或现代 Flex/Grid）。