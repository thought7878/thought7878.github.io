CSS 的 **堆叠上下文（Stacking Context）** 是一个非常重要的概念，它决定了页面中元素的层级关系和绘制顺序。理解堆叠上下文可以帮助开发者更好地控制元素的显示顺序，尤其是在处理复杂的布局或动画时。


---

### 1. **什么是堆叠上下文？**
堆叠上下文是一个三维的概念，用于描述页面中元素在 Z 轴上的堆叠顺序。每个堆叠上下文都有一个独立的层级空间，其中的元素按照一定的规则进行排序。

- **根堆叠上下文**：每个页面都有一个默认的根堆叠上下文，由 `<html>` 元素创建。
- **子堆叠上下文**：某些特定条件会触发新的堆叠上下文，这些上下文嵌套在根堆叠上下文中。

---

### 2. **堆叠上下文的作用**
- **控制层级关系**：堆叠上下文决定了元素在 Z 轴上的显示顺序。
- **隔离作用**：子堆叠上下文中的元素不会影响父堆叠上下文或其他堆叠上下文的层级关系。
- **优化渲染**：浏览器可以更高效地处理堆叠上下文中的元素，避免不必要的重绘和合成。

---

### 3. **触发堆叠上下文的条件**
以下是一些常见的触发堆叠上下文的条件：
#### （1）**根元素**
- 页面的根元素（`<html>`）始终会创建一个堆叠上下文。

#### （2）**定位与 `z-index`**
- 当元素设置了以下属性时，会创建一个新的堆叠上下文：
  - `position` 值为 `relative`、`absolute` 或 `fixed`，并且 `z-index` 不为 `auto`。
  - 示例：
    ```css
    .example {
      position: relative;
      z-index: 1;
    }
    ```

#### （3）**透明度**
- 当元素的 `opacity` 值小于 1 时，会创建一个新的堆叠上下文。
  ```css
  .example {
    opacity: 0.9;
  }
  ```

#### （4）**变换**
- 当元素设置了 `transform` 属性且值不为 `none` 时，会创建一个新的堆叠上下文。
  ```css
  .example {
    transform: translateZ(0);
  }
  ```

#### （5）**滤镜**
- 当元素设置了 `filter` 属性且值不为 `none` 时，会创建一个新的堆叠上下文。
  ```css
  .example {
    filter: blur(2px);
  }
  ```

#### （6）**混合模式**
- 当元素设置了 `mix-blend-mode` 属性且值不为 `normal` 时，会创建一个新的堆叠上下文。
  ```css
  .example {
    mix-blend-mode: multiply;
  }
  ```

#### （7）**裁剪**
- 当元素设置了 `clip-path` 或 `mask` 属性时，会创建一个新的堆叠上下文。
  ```css
  .example {
    clip-path: circle(50%);
  }
  ```

#### （8）**`will-change`**
- 当元素设置了 `will-change` 属性，并包含上述任何触发条件时，会创建一个新的堆叠上下文。
  ```css
  .example {
    will-change: transform;
  }
  ```

#### （9）**`isolation`**
- 当元素设置了 `isolation: isolate` 时，会创建一个新的堆叠上下文。
  ```css
  .example {
    isolation: isolate;
  }
  ```

#### （10）**`contain`**
- 当元素设置了 `contain: paint` 或 `contain: strict` 时，会创建一个新的堆叠上下文。
  ```css
  .example {
    contain: paint;
  }
  ```

---

### 4. **堆叠上下文的层级规则**
在一个堆叠上下文中，元素的堆叠顺序遵循以下规则（从低到高）：
1. **背景和边框**：堆叠上下文的背景和边框。
2. **负 `z-index` 元素**：具有负 `z-index` 值的子元素。
3. **块级元素**：普通的块级元素（如 `<div>`）。
4. **浮动元素**：设置了 `float` 的元素。
5. **内联元素**：普通内联元素（如文本）。
6. **`z-index: auto` 或 `z-index: 0` 元素**：未设置 `z-index` 或设置为 `0` 的子元素。
7. **正 `z-index` 元素**：具有正 `z-index` 值的子元素。

---

### 5. **堆叠上下文的嵌套**
堆叠上下文是嵌套的，子堆叠上下文的层级只在其父堆叠上下文中有效。例如：
```html
<div class="parent">
  <div class="child"></div>
</div>
```
```css
.parent {
  position: relative;
  z-index: 1;
}
.child {
  position: relative;
  z-index: 10;
}
```
- `.child` 的 `z-index: 10` 只在其父元素 `.parent` 的堆叠上下文中有效。
- 如果 `.parent` 的 `z-index` 低于其他堆叠上下文中的元素，则 `.child` 也无法覆盖那些元素。

---

### 6. **堆叠上下文的性能影响**
堆叠上下文对性能有以下影响：
- **提升性能**：浏览器可以将堆叠上下文中的元素作为一个整体进行绘制和合成，减少重绘和重排。
- **潜在问题**：过多的堆叠上下文可能导致 GPU 资源占用过高，尤其是在使用 `transform` 或 `opacity` 触发硬件加速时。

---

### 7. **如何调试堆叠上下文？**
现代浏览器提供了强大的开发者工具，可以帮助我们查看和分析堆叠上下文：
- **Chrome DevTools**：
  - 打开“Rendering”面板，勾选“Layer borders”可以查看图层边界。
  - 在“Performance”面板中录制页面性能，可以看到堆叠上下文的生成和合成过程。
- **Safari Web Inspector** 和 **Firefox Developer Tools**：
  - 提供类似的堆叠上下文调试功能。

---

### 8. **总结**
堆叠上下文是 CSS 中控制元素层级关系的核心机制。通过合理利用堆叠上下文，可以更好地管理页面的视觉层次结构，同时优化渲染性能。
