> [!attention] 
> 更详细的，参考浏览器的渲染流程

浏览器解析HTML的过程是一个复杂而有序的步骤，涉及多个阶段和技术。以下是浏览器解析HTML的详细过程及其背后的原理：

---

## **1. 浏览器解析HTML的整体流程**

当用户访问一个网页时，浏览器会按照以下步骤处理HTML文档：

### **(1) 获取HTML文档**
- 用户输入URL后，浏览器通过HTTP/HTTPS协议向服务器请求HTML文件。
- 服务器返回HTML文档内容。

### **(2) 解析HTML文档**
- 浏览器接收到HTML文档后，开始解析其内容。
- HTML解析器将HTML代码转换为**DOM（Document Object Model）树**，这是浏览器理解网页结构的基础。

### **(3) 构建渲染树**
- 浏览器结合CSS样式信息，生成**渲染树（Render Tree）**。
- 渲染树包含所有可见的元素及其样式信息（隐藏元素如`display: none`不会出现在渲染树中）。

### **(4) 布局（Layout）**
- 浏览器计算每个元素在页面上的位置和大小（称为“布局”或“重排”）。
- 这一步决定了每个元素在屏幕上的具体坐标。

### **(5) 绘制（Painting）**
- 浏览器将渲染树中的每个节点绘制到屏幕上。
- 包括文本、颜色、边框等视觉效果。

### **(6) 显示网页**
- 最终，浏览器将渲染完成的内容显示给用户。

---

## **2. HTML解析的详细过程**

HTML解析是整个流程的核心部分，以下是HTML解析的具体步骤：

### **(1) 分词（Tokenization）**
- 浏览器将HTML文档逐字符读取，并将其分割成一个个“标记（Token）”。
- 标记包括开始标签（如`<div>`）、结束标签（如`</div>`）、属性（如`class="example"`）以及文本内容。

#### 示例：
HTML代码：
```html
<div class="container">
    <p>Hello, World!</p>
</div>
```
分词结果：
- `<div>`：开始标签
- `class="container"`：属性
- `<p>`：开始标签
- `Hello, World!`：文本内容
- `</p>`：结束标签
- `</div>`：结束标签

---

### **(2) 构建DOM树**
- 浏览器根据分词结果，将标记逐步转换为DOM节点，并构建出一棵**DOM树**。
- DOM树表示了HTML文档的层级结构，每个节点对应一个HTML元素。

#### 示例：
上述HTML代码对应的DOM树结构：
```
HTML
└── body
    └── div (class="container")
        └── p
            └── 文本节点 "Hello, World!"
```

---

### **(3) 处理嵌套资源**
- 在解析过程中，如果遇到外部资源（如CSS文件、JavaScript文件、图片等），浏览器会发起额外的网络请求来加载这些资源。
- **CSS文件**：用于构建渲染树。
- **JavaScript文件**：可能会阻塞HTML解析（除非使用`async`或`defer`属性）。

---

### **(4) 错误处理**
- HTML解析器对错误具有很高的容错性。即使HTML代码存在语法错误（如未闭合的标签），浏览器也会尝试修复并继续解析。
- 例如：
  ```html
  <div>
      <p>段落内容
  </div>
  ```
  浏览器会自动补全未闭合的`<p>`标签，使其成为：
  ```html
  <div>
      <p>段落内容</p>
  </div>
  ```

---

## **3. 渲染树的构建**

在HTML解析完成后，浏览器会结合CSS样式信息生成渲染树。以下是渲染树构建的关键步骤：

### **(1) 应用CSS样式**
- 浏览器根据CSS规则（包括内联样式、外部样式表和默认样式）为每个DOM节点计算最终的样式。

### **(2) 筛选可见元素**
- 隐藏元素（如`display: none`）不会出现在渲染树中，但`visibility: hidden`的元素仍然会保留。

### **(3) 生成渲染树**
- 渲染树由一组带有样式信息的节点组成，这些节点直接对应屏幕上的可见内容。

---

## **4. 布局与绘制**

### **(1) 布局（Layout）**
- 浏览器计算每个节点在页面上的精确位置和大小。
- 布局过程可能会因为窗口大小变化或动态内容更新而重复执行（称为“重排”）。

### **(2) 绘制（Painting）**
- 浏览器将渲染树中的每个节点绘制到屏幕上。
- 绘制过程包括绘制背景、边框、文本等内容。

---

## **5. JavaScript的影响**

JavaScript可以动态修改HTML和CSS，从而影响解析和渲染过程：
- **阻塞解析**：默认情况下，JavaScript会阻塞HTML解析，直到脚本执行完成。
- **异步加载**：通过`<script async>`或`<script defer>`属性，可以让JavaScript异步加载，避免阻塞HTML解析。

---

## **6. 总结：浏览器解析HTML的核心步骤**

1. **获取HTML文档**：通过HTTP/HTTPS请求获取HTML文件。
2. **分词**：将HTML代码分割为标记（Token）。
3. **构建DOM树**：将标记转换为DOM节点，形成DOM树。
4. **处理嵌套资源**：加载CSS、JavaScript等外部资源。
5. **构建渲染树**：结合CSS样式信息生成渲染树。
6. **布局**：计算每个元素的位置和大小。
7. **绘制**：将渲染树中的内容绘制到屏幕上。
8. **显示网页**：最终呈现完整的网页。

---

## **关键点回顾**
- **DOM树**：表示HTML文档的结构。
- **渲染树**：包含所有可见元素及其样式信息。
- **布局与绘制**：确定元素的位置并绘制到屏幕上。
- **JavaScript**：可能会影响解析和渲染过程。

通过了解浏览器如何解析HTML，你可以更好地优化网页性能，例如减少不必要的重排和重绘，合理使用异步加载等技术。