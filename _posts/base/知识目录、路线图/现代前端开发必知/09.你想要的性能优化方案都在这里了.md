【【现代前端开发必知09】你想要的性能优化方案都在这里了】 https://www.bilibili.com/video/BV1R9xNeaEsa/?share_source=copy_web&vd_source=9c1e19a73fa7bd23bb37aa8d7467d862


用户体验毫无疑问是前端工程师的关注重点。我们**之前介绍的计算机网络、编程语言、工具链、用户界面和应用框架，其实都是为用户体验而服务的**。这里说的用户体验是广义上的，*包含终端用户体验（UX）和开发者体验（DX）*。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/01b83156d7c3dbc869afb534a512296a_MD5.jpeg]]

**前端作为人机交互的桥梁**，在现代工具和框架的加持下，又**该如何把人机交互体验做到极致呢？** 我们将从四个方面讨论大家默认的狭义上的终端用户体验，分别是`性能`、`UI设计`、`可访问性`、`个性化`。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/cbe7c8a2169a7be737d4ea0122aab1eb_MD5.jpeg]]

由于内容较多，*本期我们先聚焦于性能优化这个主题*。

# 性能分析工具
**在进行性能优化前**，我们应该*通过性能分析工具来观察页面各阶段的耗时和性能指标*，*有针对性进行优化，避免过早或过度优化*。
以最常用的chrome dev tools的performance面板为例，值得关注的地方是：
- **Network栏中标红的资源**，这些资源*会阻塞页面渲染*。
- **Timings栏中的各时间戳**，`FCP`表示用户看到页面第一个元素的时刻，`LCP`差不多是页面完整呈现的时间。
- **Main栏火焰图中标红的函数调用**，表示*执行耗时较长的函数*，是我们*排查低性能代码*的重要途径。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/98aaba697382e6a1092f996d4a51f9af_MD5.jpeg]]

![[_posts/base/知识目录、路线图/现代前端开发必知/media/8e400a27c1d7999d4dd32ad6ac9e2336_MD5.jpeg]]

![[_posts/base/知识目录、路线图/现代前端开发必知/media/74c1259402eeecb7757598e03e48e818_MD5.jpeg]]

![[_posts/base/知识目录、路线图/现代前端开发必知/media/5d2706fbcbe158c74e9219b5660929ff_MD5.jpeg]]

# 前端的性能问题
前端的性能问题通常可以**归结为三个方面**，**页面加载时间太长、交互过程不流畅、资源消耗过度**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/c76a7377b959ced81e729c9caef51f4b_MD5.jpeg]]

## 加载时间太长
**导致页面加载时间太长的原因**有很多，比如**资源体积过大、网络延迟较高、缺少缓存、渲染受阻**等等。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/41f78a3812b44d0af31114510d20ae13_MD5.jpeg]]

### 资源体积过大
**针对资源体积过大的问题**有两个主要途径，**减小产物大小，减少传输量**。

#### 减小产物大小
###### 压缩（Compression）
###### 树摇（Tree Shaking）
###### 依赖外置（External Modules）
现代前端框架集成的`构建工具`提供了`压缩（Compression）`、`树摇（Tree Shaking）`、`依赖外置（External Modules）`等功能**来减小产物大小**

#### 减少传输量
###### 代码拆分（Code Splitting）
###### 按需加载/ 懒加载（Lazy Loading）
提供`代码拆分（Code Splitting）`、`懒加载/按需加载（Lazy Loading）`等基本功能**来减少传输量**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/48a830974cb0e18e8530486a6af1541b_MD5.jpeg]]

###### 服务端渲染（服务器组件、流式渲染）
主流前端应用框架还支持`服务端渲染`，部分基于react的应用框架还提供**更先进的`服务器组件`以及`流式渲染`技术**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/b77df57522e47d4f294086902bb1ac84_MD5.jpeg]]
和服务端渲染不同的是，**`流式渲染`技术实现了`分段渲染`和传输，可以让用户尽可能快地看见有效内容**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/a22ff007630444656cfa05f53779f77f_MD5.jpeg]]
###### 静态生成
此外还有`静态生成`技术，他**在构建阶段**就**生成好静态页面**，用户直接访问静态页面，**省掉了大量的客户端脚本（构建阶段渲染，省掉了客户端、服务端渲染）**。
它包含两种形态，`静态站点生成（SSG-Static Site Generation）`和`增量静态生成（ISR- Incremental Static Regeneration）`，适用于不同的业务场景。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/a7fa4609498a78ea4e9a725f3d6180e4_MD5.jpeg]]

### 网络延迟高
[02:43]
说完资源体积过大的问题，我们再来看看网络延迟高怎么解决。

#### 启用HTTP2协议
**启用HTTP2协议**（多路复用、二进制帧层、头部压缩），*提升网络并发传输效率*。

#### 使用CDN分发静态资源
使用CDN分发静态资源

#### 边缘计算节点
在边缘计算节点部署无服务器应用

#### 使用浏览器资源提示属性
**使用浏览器资源提示属性**，如*预加载（preload）、预取（prefetch）、DNS预解析（dns-prefetch）、预连接（preconnect）*
![[_posts/base/知识目录、路线图/现代前端开发必知/media/52d25fc833be3f8491eb7a577a823a90_MD5.jpeg]]

#### 优化图片
**对图片进行专项优化：**
- 使用现代图片格式webp、avif，
- 预渲染缩略图，
- 在标准image的loading、fetchpriority、decoding、srcset属性上进行优化等等。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/eabecf95bc7dbb7ffff8e1c55b994c3b_MD5.jpeg]]

以上就是网络延迟高的通用解法

### 缺少缓存
接下来我们再看看缓存的必要性，前端应用*在许多环节都会用到缓存*，大致可以分为`本地缓存`和`远端缓存`两类。
`本地缓存`是指**存储在终端设备上的缓存**，而`远端缓存`则是**存储在服务设备上的缓存**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/b475dcad0bcbce7115d86c3f1f1fd53a_MD5.jpeg]]

#### 配置本地缓存
###### HTTP协议的缓存头
我们可以**利用HTTP协议的缓存头**，如cache-control、last-modified、etag等**来协商缓存的存储方式**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/76ab4c9d9e8dc6842bc18c8622ac8edc_MD5.jpeg]]
 
###### 浏览器存储API
**用浏览器存储API**，如localStorage、indexedDB来**手动管理缓存**

###### Service Worker
**利用service worker天生的缓存功能**来最大程度缩短页面加载的时间。

#### 配置远端缓存
我们也可以**在服务端或代理设备上配置远端缓存**，如**内存缓存、边缘缓存、网关缓存**等方案，提高缓存利用率，能有效提升应用的响应速度和整体服务的健壮性。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/060e5735d7309adae1e03585dfbab381_MD5.jpeg]]

### 渲染受阻
如果你已经做完资源体积优化、网络延迟优化、缓存优化，还想做的更极致，那么页面的渲染过程就是一个不错的优化方向。

#### 异步加载
**为了进一步缩短由于渲染过程带来的白屏窗口**，我们可以**将非关键的JS文件标记为异步加载**（async或defer），**来避免它们阻塞HTML解析**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/8bb9a16bfd5eabdf6e3241c9c1bff5ab_MD5.jpeg]]

#### 采用`Web Worker`和`WebAssembly`
另外也可以采用`Web Worker`和`WebAssembly`技术，**将非常消耗计算资源的任务移出主线程和加速计算**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/1efbed773efbd92b832e260dd8f230bb_MD5.jpeg]]

![[_posts/base/知识目录、路线图/现代前端开发必知/media/0b6b1a7456346a01691fbe16afa21b5e_MD5.jpeg]]

#### 针对SPA的优化：预写入数据
**对于白屏时间较长的SPA单页应用**，可以**在主文档全局变量中预写入数据**来**减少首屏代码中的接口请求**，加速页面渲染。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/0add5164780371e15a0f83164a2b57df_MD5.jpeg]]


*小结一下*，资源体积过大，网络延迟较高，缺少缓存，渲染过程有阻碍，都会导致页面加载时间太长。

## 交互过程不流畅
[05:10]
聊完页面加载时间太长这个问题，接下来我们再看交互过程不流畅如何解决。

**导致交互过程不流畅的原因**主要*有三类*，**海量的数据、大量的动画、频繁的交互**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/99ede9a8baf8c702a33feb99cab04cef_MD5.jpeg]]

### 海量数据
**海量数据渲染场景**包括`长列表展示`和`大数据可视化`。

#### 长列表展示
对于`长列表展示`，我们可以**通过`分页`和`虚拟滚动`技术，选择性渲染在用户可见范围内的元素，而不是整个列表**。比如，*ant design组件库的select组件*就使用了虚拟滚动技术。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/bfa2eaeb681ca517dd169b31f24bacd7_MD5.jpeg]]

#### 大数据可视化
对于大数据可视化，我们可以借助**数据抽样、分片渲染、Canvas渲染、WebGL加速**技术来**分摊图形计算压力**。许多*开源图表库和2D/3D渲染引擎*都支持Canvas和WebGL。

此外还可以通过`离屏渲染（Offscreen Rendering）`技术，**在屏幕外的缓冲区中进行图像合成，再一次性显示，减少屏幕卡顿和闪烁**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/9d05b125b16d4249185eaa5cfe72c98f_MD5.jpeg]]

### 大量动画
**大量的动画**需求也是**容易引起交互过程不流畅**的重要因素。许多页面会包含动效，特别是大促产品营销场景，如果全部*使用未经优化的animation或JS动画，会显著影响页面的帧率（FPS）*。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/2fd64a457baf98d785da214fc58307a6_MD5.jpeg]]

#### 开启CSS硬件加速：使用有硬件加速功能的CSS属性
首先最基本的应该多**在动画上使用带有硬件加速功能的CSS属性**，如*transform、opacity、perspective*等，也可以使用浏览器提供的`requestAnimationFrame()函数`或是`开源动效方案`，如*Lottie、Framer Motion*等，他们都可以提供不错的性能和效果。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/fb34d781d67842a5f6b1e8e3ff83dfd6_MD5.jpeg]]

### 频繁的交互
*许多用户在界面反馈不及时的情况下，会更频繁的点击、输入或滑动，严重时可能导致程序异常*。

#### 防抖（Debounce）
#### 节流（Throttle）
#### 利用UI框架提供的方案
除了大家都知道的`防抖（Debounce）`和`节流（Throttle）`外。

我们还可以**利用UI框架提供的方案**，比如，Vue提供的v-show、KeepLive组件，*React提供的useTransition、useDeferredValue、即将推出的useOptimistic*来实现更友好的交互反馈。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/57fe7ee4cd36588d820e3235fce94173_MD5.jpeg]]

## 资源消耗过多
最后是导致资源消耗过多的因素。主要有两类：**不合理的资源加载、代码质量问题**。这里的资源包括计算资源、CPU内存占用网络资源、带宽流量以及依赖电池供电设备的电量等等。错误的构建设置、未经优化的静态资源、三方库滥用无效的缓存等，都会导致不合理的资源加载。要解决这些问题，首先需要选择主流的应用框架，其次是克制的使用三方依赖，然后是使用分析工具了解构建产物的组成、去除或拆分过大的一外包等等。

接下来是常见的代码质量问题，比如只监听不卸载的事件，处理器长时间执行的同步代码、频繁的网络请求等，都是典型的代码质量问题。代码问题是一直存在的，只要是人就会犯错。要减少代码错误，除了吸取前人的经验教训外，我想更多需要借助自动化工具，甚至是AI助手来分析和修复可能产生的问题代码。

前面我们提到的一些优化方案需要依赖浏览器特性才能实现，比如浏览器资源提示、图片优化属性、web storage、API、web worker等。其实，目前许多超级APP play的H5小程序都不是直接运行在浏览器中，而是运行在所谓的容器中，可以理解为一个经过APP定制和增强的浏览器内核。基于容器，我们可以实现更多浏览器实现不了的强大优化方案。比如离线包在特定的时机下载静态资源容器，从离线包中加载依赖，可以提升H5应用的加载速度。

小程序一套完全独立于传统PWA的架构，从渲染引擎开始重构，可以拥有更接近原生渲染的性能体验。本期我们画了较大的篇幅介绍了前端性能问题的产生原因以及通用应对策略。不过这仅仅是用户体验的一部分。下一期我们会从UI优化和访问性和个性化这三个角度出发再聊用户体验。记得点个关注，我是小麦，我们下期再见。