【【现代前端开发必知09】你想要的性能优化方案都在这里了】 https://www.bilibili.com/video/BV1R9xNeaEsa/?share_source=copy_web&vd_source=9c1e19a73fa7bd23bb37aa8d7467d862


用户体验毫无疑问是前端工程师的关注重点。我们**之前介绍的计算机网络、编程语言、工具链、用户界面和应用框架，其实都是为用户体验而服务的**。这里说的用户体验是广义上的，*包含终端用户体验（UX）和开发者体验（DX）*。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/01b83156d7c3dbc869afb534a512296a_MD5.jpeg]]

**前端作为人机交互的桥梁**，在现代工具和框架的加持下，又**该如何把人机交互体验做到极致呢？** 我们将从四个方面讨论大家默认的狭义上的终端用户体验，分别是`性能`、`UI设计`、`可访问性`、`个性化`。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/cbe7c8a2169a7be737d4ea0122aab1eb_MD5.jpeg]]

由于内容较多，*本期我们先聚焦于性能优化这个主题*。

## 性能分析工具
**在进行性能优化前**，我们应该*通过性能分析工具来观察页面各阶段的耗时和性能指标*，*有针对性进行优化，避免过早或过度优化*。
以最常用的chrome dev tools的performance面板为例，值得关注的地方是：
- **Network栏中标红的资源**，这些资源*会阻塞页面渲染*。
- **Timings栏中的各时间戳**，`FCP`表示用户看到页面第一个元素的时刻，`LCP`差不多是页面完整呈现的时间。
- **Main栏火焰图中标红的函数调用**，表示*执行耗时较长的函数*，是我们*排查低性能代码*的重要途径。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/98aaba697382e6a1092f996d4a51f9af_MD5.jpeg]]

![[_posts/base/知识目录、路线图/现代前端开发必知/media/8e400a27c1d7999d4dd32ad6ac9e2336_MD5.jpeg]]

![[_posts/base/知识目录、路线图/现代前端开发必知/media/74c1259402eeecb7757598e03e48e818_MD5.jpeg]]

![[_posts/base/知识目录、路线图/现代前端开发必知/media/5d2706fbcbe158c74e9219b5660929ff_MD5.jpeg]]

## 前端的性能问题
前端的性能问题通常可以**归结为三个方面**，**页面加载时间太长、交互过程不流畅、资源消耗过度**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/c76a7377b959ced81e729c9caef51f4b_MD5.jpeg]]

### 加载时间太长
**导致页面加载时间太长的原因**有很多，比如**资源体积过大、网络延迟较高、缺少缓存、渲染受阻**等等。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/41f78a3812b44d0af31114510d20ae13_MD5.jpeg]]

#### 资源体积过大
**针对资源体积过大的问题**有两个主要途径，**减小产物大小，减少传输量**。现代前端框架集成的构建工具提供了压缩束尧，依赖外置功能来减小产物大小，同时提供代码拆分、按需加载等基本功能来减少传输量。主流前端应用框架还支持服务端渲染部分，基于react的应用框架还提供更先进的服务器组件以及流式渲染技术。和服务端渲染不同的是，流式渲染技术实现了分段渲染和传输，可以让用户尽可能快地看见有效内容。此外还有静态生成技术，他在构建阶段就生成好静态页面，用户直接访问静态页面，省掉了大量的客户端脚本。它包含两种形态，静态站点生成和增量静态生成，适用于不同的业务场景。

说完资源体积过大的问题，我们再来看看网络延迟高怎么解决。我们可以启用HTTPR协议，提升网络并发传输效率。使用cdn分发静态资源，在边缘计算节点部署无服务器应用，使用浏览器资源提示属性，如预加载preload、预取prefect DNS预解析、DNS prefect预连接reconnect，对图片进行专项优化，如使用现代图片格式VP和AVIF预渲染缩略图，在标准image的loading face priority decoding SRC set属性上进行优化等等。

以上就是网络延迟高的通用解法，接下来我们再看看缓存的必要性，前端应用在许多环节都会用到缓存，大致可以分为本地缓存和远端缓存两类。顾名思义，本地缓存是指存储在终端设备上的缓存，而远端缓存则是存储在服务设备上的缓存。我们可以利用HTTP协议的缓存头，如cache control、last modified e tag等来协商缓存的存储方式。也可以用浏览器存储API，如local storage index的DB来手动管理缓存，或者利用service worker天生的缓存功能来最大程度缩短页面加载的时间。我们也可以在服务端或代理设备上配置远端缓存，如内存缓存、边缘缓存、网关缓存等方案，提高缓存利用率，能有效提升应用的响应速度和整体服务的健壮性。

如果你已经做完资源体积优化、网络延迟优化、缓存优化，还想做的更极致，那么页面的渲染过程就是一个不错的优化方向。为了进一步缩短由于渲染过程带来的白屏窗口，我们可以将非关键的JS文件标记为异步加载i think或defer，来避免它们阻塞HTML解析。另外也可以采用web worker和web symbolic技术，将非常消耗计算资源的任务移出主线程和加速计算。对于白屏时间较长的SPA单页应用，可以在主文档全局变量中预写入数据来减少首屏代码中的接口请求，加速页面渲染。小结一下，资源体积过大，网络延迟较高，缺少缓存，渲染过程有阻碍，都会导致页面加载时间太长。

聊完页面加载时间太长这个问题，接下来我们再看交互过程不流畅如何解决。导致交互过程不流畅的原因主要有三类，海量的数据，大量的动画以及频繁的交互。海量数据渲染场景包括长列表展示和大数据可视化。对于长列表展示，我们可以通过分页和虚拟滚动技术选择性渲染在用户可见范围内的元素，而不是整个列表。比如enter design组件库的select组件就使用了虚拟滚动技术。对于大数据可视化，我们可以借助数据抽样、分片渲染、canvas渲染、web GL加速技术来分摊图计算压力。许多开源图表库和2D3D渲染引擎都支持canvas和web GL此外还可以通过离屏渲染技术，在屏幕外的缓冲区中进行图像合成，再一次性显示，减少屏幕卡顿和闪烁。

接着大量的动画需求也是容易引起交互过程不流畅的重要因素。许多页面会包含动效，特别是大促产品营销场景，如果全部使用未经优化的animation或GS动画，会显著影响页面的帧率。首先最基本的应该多在动画上使用带有硬件加速功能的CSS属性，如transform、opacity、perspective等，也可以使用浏览器提供的request animation、frame函数或是开源动销方案，如loti和farmer motion等，他们都可以提供不错的性能和效果。许多用户在界面反馈不及时的情况下，会更频繁的点击、输入或滑动，严重时可能导致程序异常。除了大家都知道的防抖和节流外，我们还可以利用UI框架提供的方案，比如vio提供的v show和keep live组件，react提供的use traction，use differing value和即将推出的use optimistic来实现更友好的交互反馈。

最后是导致资源消耗过多的因素。主要有两类，不合理的资源加载代码质量问题。这里的资源包括计算资源、CPU内存占用网络资源、带宽流量以及依赖电池供电设备的电量等等。错误的构建设置、未经优化的静态资源、三方库滥用无效的缓存等，都会导致不合理的资源加载。要解决这些问题，首先需要选择主流的应用框架，其次是克制的使用三方依赖，然后是使用分析工具了解构建产物的组成、去除或拆分过大的一外包等等。

接下来是常见的代码质量问题，比如只监听不卸载的事件，处理器长时间执行的同步代码、频繁的网络请求等，都是典型的代码质量问题。代码问题是一直存在的，只要是人就会犯错。要减少代码错误，除了吸取前人的经验教训外，我想更多需要借助自动化工具，甚至是AI助手来分析和修复可能产生的问题代码。

前面我们提到的一些优化方案需要依赖浏览器特性才能实现，比如浏览器资源提示、图片优化属性、web storage、API、web worker等。其实，目前许多超级APP play的H5小程序都不是直接运行在浏览器中，而是运行在所谓的容器中，可以理解为一个经过APP定制和增强的浏览器内核。基于容器，我们可以实现更多浏览器实现不了的强大优化方案。比如离线包在特定的时机下载静态资源容器，从离线包中加载依赖，可以提升H5应用的加载速度。

小程序一套完全独立于传统PWA的架构，从渲染引擎开始重构，可以拥有更接近原生渲染的性能体验。本期我们画了较大的篇幅介绍了前端性能问题的产生原因以及通用应对策略。不过这仅仅是用户体验的一部分。下一期我们会从UI优化和访问性和个性化这三个角度出发再聊用户体验。记得点个关注，我是小麦，我们下期再见。