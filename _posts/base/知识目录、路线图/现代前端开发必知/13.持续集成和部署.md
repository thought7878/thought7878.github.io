【【现代前端开发必知13】持续集成和部署】 https://www.bilibili.com/video/BV1bUzPYPEnk/?share_source=copy_web&vd_source=9c1e19a73fa7bd23bb37aa8d7467d862


前端代码完成之后，如何部署到服务器上供用户访问？  
发言人：简单做法是将源代码本地打包后手动上传到服务器上，但这种方式在多人协作场景下存在标准化约束不足、效率低下和安全风险等问题。持续集成和部署（CI/CD）技术解决了这些问题，通过自动化流水线对源代码进行处理、构建和测试，并生成集成产物。  
  
持续集成（CI）是如何运作的？  
发言人：持续集成系统会在版本控制系统中接收开发者提交的源代码，然后创建虚拟容器，拉取最新代码并执行自定义脚本进行安装依赖包、链接检查和单元测试等操作，最后生成测试报告和构建产物。  
  
DGS中如何配置自动化流水线以确保前端代码的兼容性和安全性？  
发言人：在DGS中，使用GitHub Actions设置流水线，在代码变更时自动执行测试流程。流水线会创建不同版本的Node.js虚拟环境来测试代码兼容性，并执行一系列安全检查，如依赖包安装、link检查、单元测试和覆盖率测试，并将报告上传，形成覆盖率报告。  
  
持续部署（CD）的主要功能和应用场景是什么？  
发言人：持续部署紧随持续集成之后，将集成产物部署到目标环境。其关键功能包括控制发布流程，支持向多个目标环境（如应用服务器、CDN等）发布构建产物，并进行灰度发布以减少故障影响面，同时允许在任意时间回滚变更至上一版本，确保应急情况下的快速恢复。  
  
持续部署系统如何实现环境隔离？对于个人开发者来说，如何低成本接入持续集成和部署系统？  
发言人：持续部署系统支持分支代码研发场景中，开发分支上的代码会部署到开发环境或线下环境进行测试，通过流水线确保代码经过充分测试后再合并至主干分支，随后部署到生产环境或线上环境，从而兼顾研发效率和生产环境稳定性。个人开发者可以低成本地接入持续集成和部署系统，如使用Drinks、Travis CI和GitHub Actions等工具，它们提供了便捷的CI/CD解决方案，即使对于个人项目来说也是不可或缺的一部分。

---

# 为什么使用CI/CD？

前端代码写完后，如何部署到服务器上供用户访问？
![[_posts/base/知识目录、路线图/现代前端开发必知/media/c0e9592f53f9d2ae05a53fe346369b23_MD5.jpeg]]
**简单粗暴的做法**是将源代码本地打包后，再*手动上传到服务器上*。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/dec3d4c1c3b3c97c91da19a2038f19da_MD5.jpeg]]
对于*简单的业余项目*来说，这没太大问题，但在现代化的多人协作场景下，**这种方式缺少标准化约束会导致许多问题：**
- 比如，本地打包*如何保证依赖包的健康和一致性*
- 手动上传构建产物*效率低下、存在安全风险*
![[_posts/base/知识目录、路线图/现代前端开发必知/media/f69b0e20f32e93a75a05058a7f7101c9_MD5.jpeg]]

**持续集成和部署系统的出现，就是为了将这个过程`标准化`和`自动化`**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/13d03c95980bdca1d6f53e462724f39f_MD5.jpeg]]


# 持续集成（CI）
持续集成（CI、Continuous Integration）

**持续集成系统，会按照预先编排好的自动化流水线（pipeline），对源代码进行处理，得到集成产物**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/9a3fc2b90fde8d193070e19a90c26dd0_MD5.jpeg]]
- 首先开发者*将源代码提交到版本控制系统*。
- 随后持续集成系统会*创建一个虚拟容器，拉取最新代码*。
- 然后*执行项目的自定义脚本*，通常是*安装、构建、测试*脚本等等。
- 最后*生成集成产物*（可以是测试报告、构建产物等）。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/c26fe20c6869f8313f745936c027cd56_MD5.jpeg]]

这是一个前端开源库dayjs，*使用github actions持续集成服务，自动运行单元测试的流水线配置*。我们可以看到：
- 流水线会*在master或dev分支代码变更后，自动执行*。
  ![[_posts/base/知识目录、路线图/现代前端开发必知/media/43c17c80151c79b8db22bd619c7aa6b1_MD5.jpeg]]
- 流水线会*创建带有四个不同版本的Node.js的虚拟环境，来测试代码对他们的兼容情况*。
  ![[_posts/base/知识目录、路线图/现代前端开发必知/media/965f20aab4dfa5daae5aed8210a429f6_MD5.jpeg]]
- 随后，*执行依赖包安装、link检查、单元测试、覆盖率等脚本*，然后*将报告通过codecov组件上传*，最终形成这样一份覆盖率报告。
  ![[_posts/base/知识目录、路线图/现代前端开发必知/media/9ee3e3a98542b4ab4e240fed4c441b22_MD5.jpeg]]  ![[_posts/base/知识目录、路线图/现代前端开发必知/media/4c3ec5293736625c5e3bc9ba8d289dcd_MD5.jpeg]]  

![[_posts/base/知识目录、路线图/现代前端开发必知/media/33f609e4e8acc268520ccd208c40e0a8_MD5.jpeg]]

## CI的门禁
在这样一个简单的流水线中，我们还可以做更多有价值的事情。上期视频中我们提到持续集成过程中容易产生*供应链安全的问题*，可以*通过依赖锁文件或接入安全组件来屏蔽恶意软件*。除此之外，根据业务研发流程需要，还可以**对流水线中的每个阶段设置`门禁检查规则`，比如：** 
- 拉取代码后*检查基线是否最新*，
- 构建前对代码*执行静态检查*，
- 构建后*检查产物大小*等等。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/93aa3b713e8725cd52024cc1884876d1_MD5.jpeg]]

# 持续部署（CD）
持续部署（CD、Continuous Deployment）

接下来我们说持续部署CD，`持续部署`通常**紧接着持续集成进行**，即**我们将持续集成阶段输出的构建产物作为持续部署的输入**，通过自动化流水线**部署到目标环境中**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/d5b1aa8239f1d8cf44304443e4185c75_MD5.jpeg]]

## 控制发布流程
**持续部署系统的重要功能之一**是**对发布流程的控制：**
- 首先它可以**控制发布目标**：*将构建产物发布到应用服务器、NPM仓库、CDN等多个目标*。
  ![[_posts/base/知识目录、路线图/现代前端开发必知/media/df02b01d29aadb23e2bd014aee2a5fac_MD5.jpeg]]
- 其次它可以**进行灰度发布（Gray Release）**：即*按照白名单或百分比分批发布，而不是一次性全部发布，来**减少故障影响面***。
  ![[_posts/base/知识目录、路线图/现代前端开发必知/media/12af681c675841f58c567c5e99b6f1b7_MD5.jpeg]]
- 最后，持续部署系统可以**在任意时间回滚（Rollback）变更到上一个版本**。假设灰度发布期间观测到预期外的异常，可以快速回滚到上一个版本，实现应急止血。
  ![[_posts/base/知识目录、路线图/现代前端开发必知/media/dae47abdf270ebdda95d7ab5cc17a077_MD5.jpeg]]
## 环境隔离
**持续部署系统的另一个重要特性**是`环境隔离`：在*分支代码研发的场景*中，开发者*在开发分支上推送的代码会部署到开发环境（线下环境），代码经过测试后再合并到主干分支，随后部署到生产环境（线上环境）*。这样在**保证研发效率的同时，又可以提升生产环境的稳定性**。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/1326edc004409d1f5aca1efa6c952dd2_MD5.jpeg]]

**要自己从零建设一套持续集成和部署系统是非常复杂的**。而`Jenkins`、`Travis CI`、`GitHub Actions`都是不错的选择。你可能觉得持续集成和部署都是高阶玩法，我用不上，但实际上**它是现代研发流程中不可缺少的一部分**，即便是个人项目，你也可以用非常低的成本接入它。
![[_posts/base/知识目录、路线图/现代前端开发必知/media/c5ae39f74fbb5c4c5ca00ad8bde336de_MD5.jpeg]]

---

本期我们介绍了持续集成和部署系统的相关概念、功能和应用，下一期我们聊聊应用发布上线后应该关注哪些问题。