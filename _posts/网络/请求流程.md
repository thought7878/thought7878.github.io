`HTTP 请求流程`是*浏览器与服务器之间通信的核心过程*，涉及从发起请求到接收响应的多个步骤。

**流程总结：**
1. **DNS 解析**：将域名解析为 IP 地址。
2. **TCP 连接**：建立可靠的传输通道，HTTPS 需要额外的 TLS 握手。
3. **HTTP 请求**：发送请求行、请求头和请求体。
4. **服务器处理**：查找资源或生成动态内容。
5. **HTTP 响应**：返回状态行、响应头和响应体。
6. **浏览器渲染**：解析 HTML、CSS 和 JavaScript，完成页面渲染。

---

### 1. 用户发起请求

- **场景**：用户在浏览器*地址栏输入* URL（如 `https://example.com`），*点击链接*或*提交表单*。
- **触发动作**：浏览器解析 URL，准备发起 HTTP 请求。

---

### 2. 域名解析（DNS Lookup）

- **目的**：将域名（如 `example.com`）转换为服务器的 IP 地址。
- **流程**：
  1. **浏览器缓存**：检查本地缓存（如浏览器或操作系统 DNS 缓存）。
  2. **系统缓存**：若未命中，查询本地 Hosts 文件。
  3. **递归查询**：向本地 DNS 服务器（如 ISP 提供的 DNS）发起请求。
  4. **迭代查询**：本地 DNS 服务器依次向*根 DNS*、*顶级域 DNS*（如`.com`）、*权威 DNS 服务器*查询，最终获取目标 IP。
- **结果**：获得服务器 IP（如 `93.184.216.34`）。

---

### 3. 建立 TCP 连接

- **三次握手（Three-Way Handshake）**：
  1. **SYN**：客户端发送`SYN`包（同步序列号）到服务器。
  2. **SYN-ACK**：服务器响应`SYN-ACK`包（确认并同步自己的序列号）。
  3. **ACK**：客户端发送`ACK`包确认，*连接建立*。
- **目的**：确保双方均可收发数据，保障可靠传输。

---

### 4. TLS 握手（仅 HTTPS）

- **适用场景**：若 URL 以`https://`开头，需*建立安全加密通道*。
- **流程**：
  1. **客户端问候（Client Hello）**：客户端发送支持的 TLS 版本、加密套件列表、随机数。
  2. **服务器问候（Server Hello）**：服务器选择加密套件，发送证书、随机数。
  3. **密钥交换**：客户端验证证书，生成会话密钥（Pre-Master Key），用服务器公钥加密后发送。
  4. **完成握手**：双方用会话密钥生成对称加密密钥，后续通信加密。

---

### 5. 发送 HTTP 请求

- **请求组成**：
  - **请求行**：方法（GET/POST 等）、路径（如`/index.html`）、协议版本（HTTP/1.1）。
  - **请求头**：包含客户端信息、缓存策略等（如`User-Agent`, `Accept-Language`, `Cookie`）。
  - **请求体**：POST/PUT 等方法的附加数据（如表单内容、JSON）。
- **示例**：

```http
GET /index.html HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0
Accept: text/html
```

---

### 6. 服务器处理请求

- **步骤**：
  1. **路由匹配**：根据 URL 路径定位后端处理程序（如 API 路由）。
  2. **业务逻辑**：执行数据库查询、计算等操作。
  3. **生成响应**：构建 HTML 页面、JSON 数据或静态资源。
- **可能操作**：
  - 读取缓存（如 Redis、CDN 缓存）。
  - 负载均衡（转发到其他服务器）。
  - 身份验证（检查 Token 或 Cookie）。

---

### 7. 服务器返回 HTTP 响应

- **响应组成**：
  - **状态行**：协议版本、状态码（如`200 OK`、`404 Not Found`）。
  - **响应头**：内容类型（`Content-Type`）、缓存策略（`Cache-Control`）、Cookie 等。
  - **响应体**：实际数据（如 HTML、图片、JSON）。
- **示例**：

```http
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 1234

<!DOCTYPE html>
<html>...</html>
```

---

### 8. 浏览器处理响应

- **关键步骤**：
  1. **解析 HTML**：构建 DOM 树，解析 CSS 生成 CSSOM，合并为渲染树。
  2. **加载资源**：若响应是 HTML，解析其中引用的 CSS、JS、图片等资源，触发新的 HTTP 请求（可能并行）。
  3. **执行 JavaScript**：处理动态内容、发起 AJAX 请求。
  4. **渲染页面**：布局（Layout）、绘制（Paint）、合成（Composite）步骤。

---

### 9. 关闭 TCP 连接

- **四次挥手（Four-Way Handshake）**：
  1. **FIN**：客户端发送`FIN`包表示数据发送完毕。
  2. **ACK**：服务器确认`FIN`包。
  3. **FIN**：服务器发送`FIN`包表示准备关闭。
  4. **ACK**：客户端确认，连接关闭。
- **优化策略**：
	- HTTP/1.1 默认启用持久连接（`Connection: keep-alive`），复用 TCP 连接处理多个请求。
	- 如果使用 HTTP/2 或 HTTP/3，连接可以更高效地处理多个请求和响应。

---

### 性能优化策略
为了提升 HTTP 请求的性能，可以采取以下措施：

1. **减少 DNS 查询时间**：
   - 使用 DNS 预解析（`<link rel="dns-prefetch">`）。
   - 启用 DNS 缓存。
2. **使用 HTTP 新特性**：
   - 使用 HTTP/1.1 的持久连接
   - 升级到 HTTP/2、HTTP/3：多路复用、头部压缩、服务器推送。
3. **压缩资源**：
   - 对 HTML、CSS、JavaScript 和图片进行压缩（如 Gzip、Brotli）。
4. **使用 CDN**：
   - 静态资源分发到边缘节点。通过内容分发网络加速静态资源的加载。
5. **减少请求数量**：
   - 合并 CSS/JS 文件（Bundling）、使用雪碧图（CSS Sprites）等。
6. **启用缓存**：
   - 利用浏览器缓存
   - HTTP 缓存机制：强缓存（`Cache-Control: max-age=3600`）、协商缓存（`ETag`/`Last-Modified`）。
7. **延迟加载**：
   - 对非关键资源（如图片、视频）使用懒加载。

8. **预加载**：`<link rel="preload">`提前加载关键资源。

---

### 开发者工具分析（Chrome DevTools）

- **Network 面板**：
  - 查看每个请求的耗时（TTFB、Content Download）。
  - 分析请求头、响应头、状态码。
  - 筛选请求类型（XHR、JS、CSS 等）。
- **Waterfall 图**：可视化请求各阶段耗时（如 DNS、TCP、SSL、等待响应）。

---

### 常见问题

1. **跨域请求（CORS）**：受同源策略限制，需服务器设置`Access-Control-Allow-Origin`。
2. **请求阻塞**：浏览器对同一域名并发请求数限制（HTTP/1.1 为 6-8 个）。
3. **重定向过多**：检查 301/302 响应，避免循环跳转。
4. **大文件传输**：使用分块传输（`Transfer-Encoding: chunked`）或范围请求（`Range`头）。

---

通过理解 HTTP 请求流程，开发者可以针对性地优化网络性能、排查请求问题，提升用户体验。
