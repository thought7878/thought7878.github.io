[浏览器渲染原理](https://www.bilibili.com/video/BV16K4y1z7JE/?spm_id_from=333.788.top_right_bar_window_history.content.click&vd_source=22af953ea4c09540ad1966711a2d53f0)


- [02:30](https://www.bilibili.com/video/BV16K4y1z7JE/?t=150.308628#t=02:30.31) 渲染是什么？
	- browser/runtime code -render-> 像素信息（给显示器显示的数据信息）
- [04:48](https://www.bilibili.com/video/BV16K4y1z7JE/?t=288.236361#t=04:48.24) 渲染的时间点


1. **构建 DOM 树（Document Object Model Tree）**
    - **解析 HTML**：当浏览器接收到 HTML 文档后，首先会进行 HTML 解析。浏览器会将 HTML 标签按照其嵌套关系构建成一个树形结构，这个树形结构就是 DOM 树。例如，对于简单的 HTML 代码`<html><body><h1>Hello World</h1><p>Some text here.</p></body></html>`，浏览器会将`html`作为根节点，`body`是`html`的子节点，`h1`和`p`又是`body`的子节点，以此构建出 DOM 树。
    - **处理 HTML 中的资源引用**：在解析 HTML 的过程中，当遇到外部资源引用，如`<link rel="stylesheet" href="styles.css">`（引用 CSS 样式表）和`<script src="script.js"></script>`（引用 JavaScript 脚本）时，浏览器会暂停 HTML 解析，去请求和加载这些资源。加载 CSS 资源是为了后续用于样式计算，而加载 JavaScript 脚本的情况比较复杂。如果脚本没有设置`async`或`defer`属性，浏览器会停止 HTML 解析，执行脚本，之后再继续解析 HTML；如果设置了`async`属性，脚本会在下载完成后立即执行，HTML 解析不会停止；如果设置了`defer`属性，脚本会在 HTML 解析完成后执行。
2. **构建 CSSOM 树（CSS Object Model Tree）**
    - **解析 CSS**：浏览器会对 CSS 样式规则进行解析，将其转换为可以理解的内部数据结构，构建 CSSOM 树。例如，对于 CSS 规则`body { font - size:16px; color:black; }`和`h1 { color:blue; }`，浏览器会根据选择器（`body`和`h1`）和对应的样式属性构建 CSSOM 树。CSSOM 树的每个节点都代表一个 CSS 规则，它和 DOM 树一样也是一个树形结构，用于确定每个 DOM 节点的最终样式。
    - **处理样式优先级**：在构建 CSSOM 树的过程中，浏览器需要处理样式的优先级。例如，内联样式（如`<h1 style="color:red;">`）优先级高于外部样式表中的样式。浏览器会根据 CSS 的优先级规则（如！important 声明、选择器的特异性等）来确定每个 DOM 节点最终应用的样式。
3. **构建渲染树（Render Tree）**
    - **结合 DOM 树和 CSSOM 树**：渲染树是在 DOM 树和 CSSOM 树的基础上构建的。它只包含需要显示的节点，例如，设置了`display:none`的元素不会出现在渲染树中。渲染树中的每个节点都包含了其对应的 DOM 节点的布局信息和样式信息。例如，一个`<div>`元素在渲染树中的节点会包含其在 DOM 树中的位置信息，以及从 CSSOM 树中获取的宽度、高度、颜色等样式信息。
    - **计算布局（Layout）**：在构建渲染树之后，浏览器需要计算每个节点的几何信息，如位置、大小等。这一过程称为布局。浏览器会从根节点开始，递归地计算每个节点的布局信息。例如，对于一个包含多个子元素的`<div>`，浏览器会根据其自身的样式（如宽度是固定值还是根据父元素的百分比来确定）和子元素的数量、样式等因素来计算每个子元素的位置和大小。布局过程还会考虑一些复杂的情况，如浮动元素、绝对定位元素等对其他元素布局的影响。
4. **绘制（Painting）**
    - **分层（Layer）**：为了提高绘制效率，浏览器可能会将页面内容分成多个层。例如，一些动画元素或者具有复杂特效的元素可能会被单独分层。浏览器会根据渲染树中的节点信息将页面内容分层，每层都有自己的绘制顺序。
    - **生成位图（Bitmap）**：在分层之后，浏览器会将每个层的内容绘制到一个位图上。绘制过程涉及到将各种形状（如矩形、圆形等）、文本等元素按照其样式（颜色、字体等）绘制到位图中。例如，对于一个包含文本和背景颜色的`<p>`元素，浏览器会将文本按照指定的字体和颜色绘制到对应的位图区域，同时填充背景颜色。
    - **合成（Composite）**：最后，浏览器会将各个层的位图合成为最终的页面显示在屏幕上。这个过程会考虑层的顺序、透明度等因素。例如，如果一个层是半透明的，在合成时，它会与下层的内容进行混合，产生最终的视觉效果。


# 参考
- [[浏览器的渲染流程和事件循环]] = [[2021-03-22-浏览器的渲染流程和事件循环]]
