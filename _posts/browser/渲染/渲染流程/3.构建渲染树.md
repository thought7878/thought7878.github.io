在浏览器渲染流程中，**构建渲染树（Render Tree Construction）** 是一个非常重要的步骤。它负责将 DOM 树和 CSSOM 树结合起来，生成一个包含所有可见元素及其样式的结构。渲染树是后续布局、绘制和合成的基础。

---

### 1. 什么是渲染树？
渲染树是一个*中间结构*，它*结合了 DOM 树和 CSSOM 树*的信息，表示了页面上*所有可见的元素*及*其计算后的最终的样式*。渲染树中的每个节点称为 **渲染对象（Render Object）**，它们包含了布局和绘制所需的所有信息。

---

### 2. 渲染树的作用
- **过滤不可见内容**：渲染树*只包含可见的元素*，忽略 `display: none` 或被隐藏的内容。
- **整合 DOM 和 CSSOM**：*将 DOM 结构与样式规则结合起来*，为后续步骤提供完整的信息。
- **为布局和绘制做准备**：渲染树是*布局和绘制的基础*，决定了页面如何显示。

---

### 3. 构建渲染树的工作原理
构建渲染树的**主要任务**是将 DOM 树和 CSSOM 树结合起来，并生成一个包含所有可见元素的结构。以下是构建渲染树的基本步骤：

#### （1）解析 HTML 和 CSS
- 浏览器首先会解析 HTML 文件，生成 **DOM 树**。
- 同时解析 CSS 文件，生成 **CSSOM 树**。

#### （2）匹配样式
- 浏览器会根据 CSSOM 树中的样式规则，**为 DOM 树中的每个元素计算最终的样式值**。
- 这个过程称为 ***样式计算（Style Calculation）***，**它解决了样式冲突并生成了每个元素的具体样式**。

#### （3）过滤不可见元素
- 浏览器会*遍历 DOM 树*，排除以下不可见的元素：
  - 设置了 `display: none` 的元素。
  - 被隐藏的 `<script>`、`<meta>` 等*非视觉元素*。
- 只有可见的元素会被添加到渲染树中。

#### （4）创建渲染对象
- 对于每个可见的 DOM 元素，浏览器会创建一个对应的渲染对象（Render Object），*渲染对象引用（属性引用） DOM 元素*。
- 渲染对象包含了该元素的样式信息和布局属性。

#### （5）构建树状结构
- 渲染对象*按照 DOM 树的层级关系*组织起来，形成渲染树。
- 渲染树的结构*与 DOM 树类似*，但可能缺少一些不可见的节点，增加一些不可见的节点（匿名行盒/匿名块盒）。

![[_posts/browser/渲染/渲染流程/media/a5cdb4332ba6b2bd0c5673a7c497daf0_MD5.jpeg]]

![[_posts/browser/渲染/渲染流程/media/12c6c866aae154eeebe8558c8ac66ffc_MD5.jpeg]]


---

### 4. 渲染树的特点
- **只包含可见元素**：渲染树不包含 `display: none` 的元素，但包含 `visibility: hidden` 的元素（因为后者仍然占据空间）。
- **保留层级关系**：渲染树的结构与 DOM 树保持一致，但可能缺少某些节点。
- **包含样式信息**：每个渲染对象都包含了**其最终的样式值**。

---

### 5. 构建渲染树的触发条件
并非所有页面更新都会触发渲染树的重新构建。以下是一些常见的触发条件：
- **DOM 变化**：
  - 添加、删除或修改 DOM 元素。
  - 修改元素的 `class` 或 `id` 属性。
- **样式变化**：
  - 动态修改 CSS 样式（如通过 JavaScript 设置 `style` 属性）。
  - *加载新的样式表*或动态插入 `<style>` 标签。
- **窗口尺寸变化**：
  - 当浏览器窗口大小发生变化时，*可能需要重新计算样式和布局*。

---

### 6. 构建渲染树的性能影响
构建渲染树是一个*相对昂贵的*操作，尤其是当页面内容复杂时。以下是一些可能导致性能问题的情况：
- **频繁的 DOM 更新**：如果页面频繁修改 DOM 结构，会导致多次渲染树重建。
- **复杂的样式规则**：如嵌套过深的选择器或大量的样式规则，会增加样式计算的时间。
- **大规模 DOM 树**：如果 DOM 树较大，构建渲染树的时间会显著增加。

---

### 7. 如何优化构建渲染树的性能？
为了提升构建渲染树的性能，可以采取以下优化措施：

#### （1）减少 DOM 操作
- 避免频繁地添加、删除或修改 DOM 元素。
- 使用 `DocumentFragment` 或批量操作来减少 DOM 更新次数。

#### （2）简化样式规则
- 避免使用过于复杂的选择器，尽量使用简单的类选择器。
- 合并重复的样式规则，避免冗余。

#### （3）延迟加载非关键内容
- 对于不需要立即显示的内容，可以通过懒加载（Lazy Loading）延迟加载，从而减少初始渲染树的规模。

#### 测试和调试
- 使用浏览器开发者工具（如 Chrome DevTools 的 Performance 面板）分析渲染树的构建性能。
- 关注样式计算时间（Recalculate Style Time）和布局时间（Layout Time）。

---

### 8. 总结
构建渲染树是浏览器渲染流程中的核心步骤之一，直接影响到页面的视觉效果和性能。通过合理优化 DOM 和样式规则，可以显著提升渲染树的构建效率，从而提高页面的渲染性能和用户体验。
